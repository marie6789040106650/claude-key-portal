# P2.9 UI/UXå®Œå–„ - è¯¦ç»†æ‰§è¡Œè®¡åˆ’

**åˆ›å»ºæ—¶é—´**: 2025-10-10
**åˆ†æ”¯**: `feature/p2-usage-analytics`
**å‰ç½®ä¾èµ–**: P2.1-P2.8å·²å®Œæˆ
**é¢„è®¡å·¥æœŸ**: 1.5-2å¤© (8-11å°æ—¶)

---

## ğŸ“‹ è®¡åˆ’æ¦‚è§ˆ

### ç›®æ ‡
å®Œå–„Statsé¡µé¢çš„ç”¨æˆ·ä½“éªŒï¼Œç§»é™¤æ‰€æœ‰æ¨¡æ‹Ÿæ•°æ®ï¼Œé›†æˆçœŸå®CRSè¶‹åŠ¿APIï¼Œæ·»åŠ é™çº§æç¤ºå’Œæ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½ã€‚

### æ ¸å¿ƒåŸåˆ™
- âœ… ç§»é™¤æ‰€æœ‰æ¨¡æ‹Ÿæ•°æ®ï¼ˆgenerateMockTimeSeriesDataï¼‰
- âœ… é›†æˆçœŸå®CRS Usage Trend API
- âœ… æä¾›CRSé™çº§æ—¶çš„ç”¨æˆ·å‹å¥½æç¤º
- âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- âœ… éµå¾ªTDDæµç¨‹ï¼ˆğŸ”´ RED â†’ ğŸŸ¢ GREEN â†’ ğŸ”µ REFACTORï¼‰

### ä»»åŠ¡æ‹†åˆ†ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | TDDé˜¶æ®µ |
|------|--------|--------|---------|
| Task 1: é›†æˆCRSè¶‹åŠ¿API | ğŸ”´ P0 | 4-6h | ğŸ”´ ğŸŸ¢ ğŸ”µ |
| Task 2: CRSé™çº§çŠ¶æ€æç¤º | ğŸ”´ P0 | 1-2h | ğŸ”´ ğŸŸ¢ |
| Task 3: æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½ | ğŸŸ¡ P1 | 1h | ğŸŸ¢ |
| Task 4: é”™è¯¯æç¤ºä¼˜åŒ– | ğŸŸ¡ P1 | 1-2h | ğŸŸ¢ |
| Task 5: åŠ è½½è¿›åº¦æŒ‡ç¤ºå™¨ | ğŸŸ¡ P1 | 1h | ğŸŸ¢ |

---

## ğŸ¯ Task 1: é›†æˆCRSä½¿ç”¨è¶‹åŠ¿API (P0)

### ç›®æ ‡
ç§»é™¤`generateMockTimeSeriesData`æ¨¡æ‹Ÿæ•°æ®ï¼Œé›†æˆçœŸå®çš„CRS Usage Trend APIï¼Œæ˜¾ç¤ºå®é™…çš„æ—¶é—´åºåˆ—è¶‹åŠ¿å›¾ã€‚

### é—®é¢˜åˆ†æ
**å½“å‰ä»£ç ** (`app/dashboard/stats/page.tsx:76-82`):
```typescript
const timeSeriesData = useMemo<TimeSeriesDataPoint[]>(() => {
  if (!data?.keys) return []

  // TODO: ä»åç«¯è·å–å·²èšåˆçš„æ—¶é—´åºåˆ—æ•°æ®
  // å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
  return generateMockTimeSeriesData(7)
}, [data?.keys, selectedKeys])
```

**é—®é¢˜**:
- âŒ å›¾è¡¨æ˜¾ç¤ºè™šå‡æ•°æ®
- âŒ è¿åé¡¹ç›®æ ¸å¿ƒåŸåˆ™ï¼ˆæ•°æ®å¿…é¡»æ¥è‡ªCRSï¼‰
- âŒ æ— æ³•å®ç°çœŸå®çš„è¶‹åŠ¿åˆ†æ

### æŠ€æœ¯æ–¹æ¡ˆ

#### æ–¹æ¡ˆé€‰æ‹©: å¤ç”¨ç°æœ‰è¶‹åŠ¿API

**å·²å®ç°çš„API** (P2.3å®Œæˆ):
- `GET /api/stats/usage` - å·²é›†æˆCRSè¶‹åŠ¿æ•°æ®
- `lib/infrastructure/external/crs-client.ts` - å·²æœ‰`getUsageTrend()`æ–¹æ³•

**å®ç°è·¯å¾„**:
1. âœ… CRS Clientå·²å®ç°è¶‹åŠ¿è·å–ï¼ˆP2.3å®Œæˆï¼‰
2. âœ… Usage APIå·²ç¼“å­˜è¶‹åŠ¿æ•°æ®ï¼ˆP2.8å®Œæˆï¼‰
3. âŒ **ç¼ºå¤±**: UIæœªä½¿ç”¨è¶‹åŠ¿æ•°æ®ï¼ˆä»ç”¨mockï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- ğŸ¯ ä¿®æ”¹Usage APIè¿”å›æ ¼å¼ï¼ŒåŒ…å«è¶‹åŠ¿æ•°æ®
- ğŸ¯ æ›´æ–°`useUsageStats` Hookè¿”å›è¶‹åŠ¿å­—æ®µ
- ğŸ¯ ä¿®æ”¹`page.tsx`ä½¿ç”¨çœŸå®è¶‹åŠ¿æ•°æ®

---

### ğŸ”´ RED: ç¼–å†™æµ‹è¯•

#### 1.1 åˆ›å»ºè¶‹åŠ¿æ•°æ®æµ‹è¯•

**æ–‡ä»¶**: `tests/unit/app/api/stats/usage-trend.test.ts`

**æµ‹è¯•ç”¨ä¾‹**:
```typescript
describe('Usage API - Trend Data Integration', () => {
  describe('è¶‹åŠ¿æ•°æ®è·å–', () => {
    it('åº”è¯¥è¿”å›æ—¶é—´åºåˆ—è¶‹åŠ¿æ•°æ®', async () => {
      // Given: ç”¨æˆ·å·²ç™»å½•ï¼ŒCRSè¿”å›è¶‹åŠ¿æ•°æ®
      const mockTrend = [
        { date: '2024-01-01', tokens: 1000, calls: 10 },
        { date: '2024-01-02', tokens: 1500, calls: 15 },
      ]
      mockCrsClient.getUsageTrend.mockResolvedValue(mockTrend)

      // When: è°ƒç”¨API
      const response = await GET(mockRequest)
      const data = await response.json()

      // Then: åº”åŒ…å«è¶‹åŠ¿æ•°æ®
      expect(data.trend).toEqual([
        { timestamp: '2024-01-01T00:00:00.000Z', tokens: 1000, requests: 10 },
        { timestamp: '2024-01-02T00:00:00.000Z', tokens: 1500, requests: 15 },
      ])
    })

    it('åº”è¯¥æ”¯æŒè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´', async () => {
      const mockRequest = createMockRequest({
        searchParams: {
          dateRange: 'custom',
          startDate: '2024-01-01',
          endDate: '2024-01-31',
        },
      })

      const response = await GET(mockRequest)
      const data = await response.json()

      expect(mockCrsClient.getUsageTrend).toHaveBeenCalledWith({
        startDate: '2024-01-01',
        endDate: '2024-01-31',
      })
    })

    it('åº”è¯¥æ”¯æŒæŒ‰å¯†é’¥ç­›é€‰è¶‹åŠ¿', async () => {
      const mockRequest = createMockRequest({
        searchParams: {
          keyIds: 'key-1,key-2',
        },
      })

      const response = await GET(mockRequest)
      const data = await response.json()

      // åº”è°ƒç”¨CRS APIè·å–æ¯ä¸ªå¯†é’¥çš„è¶‹åŠ¿å¹¶èšåˆ
      expect(data.trend).toBeDefined()
    })
  })

  describe('è¶‹åŠ¿æ•°æ®ç¼“å­˜', () => {
    it('åº”è¯¥ç¼“å­˜è¶‹åŠ¿æ•°æ®5åˆ†é’Ÿ', async () => {
      const cacheKey = 'crs:trend:2024-01-01-2024-01-31'

      await GET(mockRequest)

      expect(mockCacheManager.set).toHaveBeenCalledWith(
        cacheKey,
        expect.any(Array),
        300 // 5åˆ†é’Ÿ
      )
    })

    it('ç¼“å­˜å‘½ä¸­æ—¶ä¸åº”è°ƒç”¨CRS API', async () => {
      mockCacheManager.get.mockResolvedValue([
        { timestamp: '2024-01-01', tokens: 1000, requests: 10 },
      ])

      await GET(mockRequest)

      expect(mockCrsClient.getUsageTrend).not.toHaveBeenCalled()
    })
  })

  describe('é”™è¯¯å¤„ç†', () => {
    it('CRSä¸å¯ç”¨æ—¶åº”è¿”å›ç©ºæ•°ç»„', async () => {
      mockCrsClient.getUsageTrend.mockRejectedValue(
        new CrsUnavailableError('CRS unavailable')
      )

      const response = await GET(mockRequest)
      const data = await response.json()

      expect(data.trend).toEqual([])
      expect(data.crsWarning).toContain('è¶‹åŠ¿æ•°æ®æš‚æ—¶ä¸å¯ç”¨')
    })
  })
})
```

**é¢„è®¡**: åˆ›å»º12ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨å¤±è´¥ï¼ˆREDçŠ¶æ€ï¼‰

**Gitæäº¤**:
```bash
git add tests/unit/app/api/stats/usage-trend.test.ts
git commit -m "test(stats): add CRS trend data integration tests (ğŸ”´ RED)"
```

---

### ğŸŸ¢ GREEN: å®ç°åŠŸèƒ½

#### 1.2 æ‰©å±•Usage APIè¿”å›è¶‹åŠ¿æ•°æ®

**æ–‡ä»¶**: `app/api/stats/usage/route.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
// æ–°å¢ç±»å‹å®šä¹‰
interface TrendDataPoint {
  timestamp: string
  tokens: number
  requests: number
}

interface UsageResponse {
  summary: { ... }
  keys: KeyStats[]
  trend?: TrendDataPoint[]  // â† æ–°å¢
  crsDashboard?: { ... }
  crsWarning?: string
}

export async function GET(request: NextRequest) {
  // ... ç°æœ‰ä»£ç  ...

  // 3. è·å–è¶‹åŠ¿æ•°æ®ï¼ˆæ–°å¢ï¼‰
  let trendData: TrendDataPoint[] = []
  try {
    const trendCacheKey = cacheManager.generateKey(
      'crs',
      'trend',
      `${startDate}-${endDate}`
    )

    // å°è¯•ä»ç¼“å­˜è·å–
    const cached = await cacheManager.get<any[]>(trendCacheKey)
    if (cached) {
      trendData = cached.map(transformTrendData)
    } else {
      // ä»CRSè·å–è¶‹åŠ¿æ•°æ®
      const crsTrend = await crsClient.getUsageTrend({
        startDate,
        endDate,
        keyIds: keyIdsFilter, // æ”¯æŒå¯†é’¥ç­›é€‰
      })

      trendData = crsTrend.map(transformTrendData)

      // ç¼“å­˜5åˆ†é’Ÿ
      await cacheManager.set(
        trendCacheKey,
        crsTrend,
        cacheManager.getTTL('trend')
      )
    }
  } catch (error) {
    console.warn('[Usage API] Failed to fetch trend data:', error)
    warnings.push('è¶‹åŠ¿æ•°æ®æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨ååˆ·æ–°')
    // ç»§ç»­æ‰§è¡Œï¼Œä¸æŠ›å‡ºé”™è¯¯
  }

  return NextResponse.json({
    summary,
    keys,
    trend: trendData,  // â† æ–°å¢
    crsDashboard,
    crsWarning: warnings.length > 0 ? warnings.join('; ') : undefined,
  })
}

// è¾…åŠ©å‡½æ•°ï¼šè½¬æ¢è¶‹åŠ¿æ•°æ®æ ¼å¼
function transformTrendData(item: any): TrendDataPoint {
  return {
    timestamp: new Date(item.date).toISOString(),
    tokens: item.tokens || 0,
    requests: item.calls || 0,
  }
}
```

**æ¶‰åŠä¿®æ”¹**:
- æ–°å¢`TrendDataPoint`ç±»å‹
- æ–°å¢`trend`å­—æ®µåˆ°å“åº”
- æ–°å¢è¶‹åŠ¿æ•°æ®è·å–å’Œç¼“å­˜é€»è¾‘
- æ–°å¢`transformTrendData`è½¬æ¢å‡½æ•°

---

#### 1.3 æ›´æ–°Hookè¿”å›è¶‹åŠ¿æ•°æ®

**æ–‡ä»¶**: `hooks/use-stats.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
export interface UsageStatsResponse {
  summary: { ... }
  keys: KeyStats[]
  trend?: TimeSeriesDataPoint[]  // â† æ–°å¢
  crsDashboard?: { ... }
  crsWarning?: string
}

// Hookä¿æŒä¸å˜ï¼Œç±»å‹è‡ªåŠ¨æ¨æ–­
```

---

#### 1.4 æ›´æ–°UIä½¿ç”¨çœŸå®è¶‹åŠ¿æ•°æ®

**æ–‡ä»¶**: `app/dashboard/stats/page.tsx`

**ä¿®æ”¹å†…å®¹**:
```typescript
// åˆ é™¤å¯¼å…¥
- import { generateMockTimeSeriesData } from '@/lib/date-utils'

// ä¿®æ”¹æ—¶é—´åºåˆ—æ•°æ®è®¡ç®—
const timeSeriesData = useMemo<TimeSeriesDataPoint[]>(() => {
-  if (!data?.keys) return []
-
-  // TODO: ä»åç«¯è·å–å·²èšåˆçš„æ—¶é—´åºåˆ—æ•°æ®
-  // å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
-  return generateMockTimeSeriesData(7)
+  // ä½¿ç”¨APIè¿”å›çš„çœŸå®è¶‹åŠ¿æ•°æ®
+  return data?.trend || []
}, [data?.trend])
```

**å…³é”®å˜åŒ–**:
- âœ… ç§»é™¤`generateMockTimeSeriesData`ä¾èµ–
- âœ… åˆ é™¤TODOæ³¨é‡Š
- âœ… ä½¿ç”¨`data.trend`çœŸå®æ•°æ®
- âœ… ä¾èµ–é¡¹ä»`[data?.keys, selectedKeys]`æ”¹ä¸º`[data?.trend]`

---

**Gitæäº¤**:
```bash
# è¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿é€šè¿‡
npm test -- usage-trend.test.ts

# æäº¤å®ç°
git add app/api/stats/usage/route.ts hooks/use-stats.ts app/dashboard/stats/page.tsx
git commit -m "feat(stats): integrate CRS trend data and remove mock data (ğŸŸ¢ GREEN)"
```

---

### ğŸ”µ REFACTOR: ä¼˜åŒ–ä»£ç 

#### 1.5 æå–è¶‹åŠ¿æ•°æ®å¤„ç†é€»è¾‘

**æ–‡ä»¶**: `app/api/stats/usage/trend-utils.ts` (æ–°å»º)

**å†…å®¹**:
```typescript
/**
 * è¶‹åŠ¿æ•°æ®å¤„ç†å·¥å…·
 */

import { crsClient } from '@/lib/infrastructure/external/crs-client'
import { cacheManager } from '@/lib/infrastructure/cache/cache-manager'

export interface TrendDataPoint {
  timestamp: string
  tokens: number
  requests: number
}

export interface FetchTrendOptions {
  startDate: string
  endDate: string
  keyIds?: string[]
}

/**
 * è·å–è¶‹åŠ¿æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
 */
export async function fetchTrendData(
  options: FetchTrendOptions
): Promise<TrendDataPoint[]> {
  const { startDate, endDate, keyIds } = options

  // ç”Ÿæˆç¼“å­˜é”®
  const cacheKey = cacheManager.generateKey(
    'crs',
    'trend',
    `${startDate}-${endDate}${keyIds ? `-${keyIds.join(',')}` : ''}`
  )

  try {
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    const cached = await cacheManager.get<any[]>(cacheKey)
    if (cached) {
      return cached.map(transformTrendData)
    }

    // 2. ä»CRSè·å–
    const crsTrend = await crsClient.getUsageTrend({
      startDate,
      endDate,
      keyIds,
    })

    const transformed = crsTrend.map(transformTrendData)

    // 3. ç¼“å­˜5åˆ†é’Ÿ
    await cacheManager.set(cacheKey, crsTrend, cacheManager.getTTL('trend'))

    return transformed
  } catch (error) {
    console.warn('[Trend Utils] Failed to fetch trend data:', error)
    return []
  }
}

/**
 * è½¬æ¢CRSè¶‹åŠ¿æ•°æ®æ ¼å¼
 */
function transformTrendData(item: any): TrendDataPoint {
  return {
    timestamp: new Date(item.date).toISOString(),
    tokens: item.tokens || 0,
    requests: item.calls || 0,
  }
}

/**
 * èšåˆå¤šä¸ªå¯†é’¥çš„è¶‹åŠ¿æ•°æ®
 */
export function aggregateTrendData(
  trends: TrendDataPoint[][]
): TrendDataPoint[] {
  const aggregated = new Map<string, { tokens: number; requests: number }>()

  for (const trend of trends) {
    for (const point of trend) {
      const existing = aggregated.get(point.timestamp) || {
        tokens: 0,
        requests: 0,
      }
      aggregated.set(point.timestamp, {
        tokens: existing.tokens + point.tokens,
        requests: existing.requests + point.requests,
      })
    }
  }

  return Array.from(aggregated.entries())
    .map(([timestamp, data]) => ({
      timestamp,
      ...data,
    }))
    .sort((a, b) => a.timestamp.localeCompare(b.timestamp))
}
```

#### 1.6 ç®€åŒ–Usage API

**æ–‡ä»¶**: `app/api/stats/usage/route.ts`

**ä¿®æ”¹**:
```typescript
import { fetchTrendData } from './trend-utils'

export async function GET(request: NextRequest) {
  // ... ç°æœ‰ä»£ç  ...

  // 3. è·å–è¶‹åŠ¿æ•°æ®
  const trendData = await fetchTrendData({
    startDate,
    endDate,
    keyIds: keyIdsFilter,
  })

  if (trendData.length === 0 && keyIdsFilter) {
    warnings.push('è¶‹åŠ¿æ•°æ®æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨ååˆ·æ–°')
  }

  return NextResponse.json({
    summary,
    keys,
    trend: trendData,
    crsDashboard,
    crsWarning: warnings.length > 0 ? warnings.join('; ') : undefined,
  })
}
```

**ä¼˜åŒ–ç‚¹**:
- âœ… æå–`fetchTrendData`å·¥å…·å‡½æ•°
- âœ… ç®€åŒ–ä¸»APIé€»è¾‘
- âœ… æé«˜ä»£ç å¤ç”¨æ€§

**Gitæäº¤**:
```bash
npm test -- usage-trend.test.ts

git add app/api/stats/usage/trend-utils.ts app/api/stats/usage/route.ts
git commit -m "refactor(stats): extract trend data utilities (ğŸ”µ REFACTOR)"
```

---

### Task 1 å®Œæˆæ ‡å‡†

- [x] âœ… ç§»é™¤æ‰€æœ‰`generateMockTimeSeriesData`è°ƒç”¨
- [x] âœ… è¶‹åŠ¿å›¾æ˜¾ç¤ºçœŸå®CRSæ•°æ®
- [x] âœ… æ”¯æŒè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
- [x] âœ… æ”¯æŒæŒ‰å¯†é’¥ç­›é€‰è¶‹åŠ¿
- [x] âœ… è¶‹åŠ¿æ•°æ®ç¼“å­˜5åˆ†é’Ÿ
- [x] âœ… CRSä¸å¯ç”¨æ—¶è¿”å›ç©ºæ•°ç»„ + è­¦å‘Š
- [x] âœ… æµ‹è¯•è¦†ç›–ç‡ > 90%
- [x] âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

**é¢„è®¡è€—æ—¶**: 4-6å°æ—¶

---

## ğŸ¯ Task 2: CRSé™çº§çŠ¶æ€UIæç¤º (P0)

### ç›®æ ‡
å½“CRSä¸å¯ç”¨æ—¶ï¼Œåœ¨UIæ˜¾ç¤ºæ˜ç¡®çš„è­¦å‘Šæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å½“å‰æ•°æ®æ¥æºå’Œé™åˆ¶ã€‚

### é—®é¢˜åˆ†æ
**å½“å‰è¡Œä¸º**:
- âœ… APIè¿”å›`crsWarning`å­—æ®µ
- âŒ UIå®Œå…¨ä¸æ˜¾ç¤ºè­¦å‘Š
- âŒ ç”¨æˆ·ä¸çŸ¥é“CRSçŠ¶æ€

**å½±å“**:
- ç”¨æˆ·å›°æƒ‘ï¼šä¸ºä»€ä¹ˆæ•°æ®ä¸å‡†ç¡®ï¼Ÿ
- ä¿¡ä»»åº¦ä¸‹é™

---

### ğŸ”´ RED: ç¼–å†™æµ‹è¯•

#### 2.1 åˆ›å»ºCRSçŠ¶æ€æç¤ºæµ‹è¯•

**æ–‡ä»¶**: `tests/unit/components/stats/CrsStatusAlert.test.tsx` (æ–°å»º)

**æµ‹è¯•ç”¨ä¾‹**:
```typescript
import { render, screen } from '@testing-library/react'
import { CrsStatusAlert } from '@/components/stats/CrsStatusAlert'

describe('CrsStatusAlert', () => {
  it('æ— è­¦å‘Šæ—¶ä¸æ˜¾ç¤º', () => {
    render(<CrsStatusAlert warning={undefined} onRetry={() => {}} />)
    expect(screen.queryByTestId('crs-status-alert')).not.toBeInTheDocument()
  })

  it('æœ‰è­¦å‘Šæ—¶æ˜¾ç¤ºAlert', () => {
    render(
      <CrsStatusAlert
        warning="CRSæœåŠ¡æš‚æ—¶ä¸å¯ç”¨"
        onRetry={() => {}}
      />
    )

    expect(screen.getByTestId('crs-status-alert')).toBeInTheDocument()
    expect(screen.getByText(/CRSæœåŠ¡æš‚æ—¶ä¸å¯ç”¨/)).toBeInTheDocument()
  })

  it('æ˜¾ç¤ºé‡è¯•æŒ‰é’®', () => {
    render(
      <CrsStatusAlert
        warning="CRS unavailable"
        onRetry={() => {}}
      />
    )

    expect(screen.getByTestId('retry-crs-button')).toBeInTheDocument()
  })

  it('ç‚¹å‡»é‡è¯•æŒ‰é’®è§¦å‘å›è°ƒ', async () => {
    const onRetry = jest.fn()
    render(<CrsStatusAlert warning="error" onRetry={onRetry} />)

    const button = screen.getByTestId('retry-crs-button')
    await userEvent.click(button)

    expect(onRetry).toHaveBeenCalledTimes(1)
  })

  it('ä½¿ç”¨warningæ ·å¼', () => {
    render(<CrsStatusAlert warning="error" onRetry={() => {}} />)

    const alert = screen.getByTestId('crs-status-alert')
    expect(alert).toHaveClass('border-warning')
  })
})
```

**Gitæäº¤**:
```bash
git add tests/unit/components/stats/CrsStatusAlert.test.tsx
git commit -m "test(stats): add CRS status alert tests (ğŸ”´ RED)"
```

---

### ğŸŸ¢ GREEN: å®ç°åŠŸèƒ½

#### 2.2 åˆ›å»ºCRSçŠ¶æ€Alertç»„ä»¶

**æ–‡ä»¶**: `components/stats/CrsStatusAlert.tsx` (æ–°å»º)

**å†…å®¹**:
```typescript
'use client'

import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Button } from '@/components/ui/button'
import { AlertCircle, RefreshCw } from 'lucide-react'

interface CrsStatusAlertProps {
  /** CRSè­¦å‘Šæ¶ˆæ¯ */
  warning?: string
  /** é‡è¯•å›è°ƒ */
  onRetry: () => void
  /** æ˜¯å¦æ­£åœ¨é‡è¯• */
  retrying?: boolean
}

export function CrsStatusAlert({
  warning,
  onRetry,
  retrying = false,
}: CrsStatusAlertProps) {
  if (!warning) return null

  return (
    <Alert
      data-testid="crs-status-alert"
      variant="warning"
      className="mb-6 border-warning bg-warning/10"
    >
      <AlertCircle className="h-4 w-4" />
      <AlertTitle className="font-semibold">CRSæœåŠ¡æš‚æ—¶ä¸å¯ç”¨</AlertTitle>
      <AlertDescription className="mt-2">
        <p className="mb-2">{warning}</p>
        <p className="text-sm text-muted-foreground mb-3">
          å½“å‰æ˜¾ç¤ºçš„æ˜¯æœ¬åœ°ç»Ÿè®¡æ•°æ®ï¼Œéƒ¨åˆ†åŠŸèƒ½ï¼ˆå¦‚å®æ—¶è¶‹åŠ¿å›¾ã€è¯¦ç»†è°ƒç”¨æ—¥å¿—ï¼‰æš‚æ—¶å—é™ã€‚
          ç³»ç»Ÿä¼šè‡ªåŠ¨é‡è¯•è¿æ¥ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ·æ–°ã€‚
        </p>
        <Button
          size="sm"
          variant="outline"
          onClick={onRetry}
          disabled={retrying}
          data-testid="retry-crs-button"
        >
          <RefreshCw
            className={`w-4 h-4 mr-2 ${retrying ? 'animate-spin' : ''}`}
          />
          {retrying ? 'è¿æ¥ä¸­...' : 'é‡è¯•è¿æ¥'}
        </Button>
      </AlertDescription>
    </Alert>
  )
}
```

#### 2.3 é›†æˆåˆ°Statsé¡µé¢

**æ–‡ä»¶**: `app/dashboard/stats/page.tsx`

**ä¿®æ”¹**:
```typescript
import { CrsStatusAlert } from '@/components/stats/CrsStatusAlert'

export default function UsageStatsPage() {
  // ... ç°æœ‰çŠ¶æ€ ...

  // æ•°æ®è·å–
  const { data, isLoading, error, refetch } = useUsageStats(
    dateRange,
    customStartDate,
    customEndDate
  )

  // å¤„ç†é‡è¯•
  const handleRetryCrs = async () => {
    await refetch()
  }

  // ... éª¨æ¶å±å’Œé”™è¯¯çŠ¶æ€ ...

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* æ ‡é¢˜å’Œæ“ä½œ */}
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">ä½¿ç”¨ç»Ÿè®¡</h1>
        <ExportDialog data={filteredKeys} />
      </div>

      {/* CRSçŠ¶æ€æç¤º - æ–°å¢ */}
      <CrsStatusAlert
        warning={data?.crsWarning}
        onRetry={handleRetryCrs}
        retrying={isLoading}
      />

      {/* æ¦‚è§ˆå¡ç‰‡ */}
      {/* ... ç°æœ‰UI ... */}
    </div>
  )
}
```

**Gitæäº¤**:
```bash
npm test -- CrsStatusAlert.test.tsx

git add components/stats/CrsStatusAlert.tsx app/dashboard/stats/page.tsx
git commit -m "feat(stats): add CRS status alert component (ğŸŸ¢ GREEN)"
```

---

### Task 2 å®Œæˆæ ‡å‡†

- [x] âœ… CRSè­¦å‘Šæ¶ˆæ¯æ˜¾ç¤ºåœ¨é¡µé¢é¡¶éƒ¨
- [x] âœ… ä½¿ç”¨Warningæ ·å¼ï¼ˆé»„è‰²Alertï¼‰
- [x] âœ… æä¾›é‡è¯•æŒ‰é’®
- [x] âœ… é‡è¯•æ—¶æ˜¾ç¤ºloadingçŠ¶æ€
- [x] âœ… ç»„ä»¶æµ‹è¯•è¦†ç›–ç‡ 100%

**é¢„è®¡è€—æ—¶**: 1-2å°æ—¶

---

## ğŸ¯ Task 3: æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½ (P1)

### ç›®æ ‡
ç”¨æˆ·å¯ä»¥éšæ—¶åˆ·æ–°æ•°æ®ï¼Œä¸å—ç¼“å­˜é™åˆ¶ã€‚

### ğŸŸ¢ GREEN: ç›´æ¥å®ç°ï¼ˆæ— éœ€æµ‹è¯•ï¼‰

**æ–‡ä»¶**: `app/dashboard/stats/page.tsx`

**ä¿®æ”¹**:
```typescript
export default function UsageStatsPage() {
  const { data, isLoading, error, refetch, isFetching } = useUsageStats(...)

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* æ ‡é¢˜å’Œæ“ä½œ */}
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">ä½¿ç”¨ç»Ÿè®¡</h1>
        <div className="flex gap-2">
          {/* åˆ·æ–°æŒ‰é’® - æ–°å¢ */}
          <Button
            variant="outline"
            onClick={() => refetch()}
            disabled={isLoading || isFetching}
            data-testid="refresh-button"
          >
            <RefreshCw
              className={cn(
                'w-4 h-4 mr-2',
                isFetching && 'animate-spin'
              )}
            />
            åˆ·æ–°
          </Button>

          <ExportDialog data={filteredKeys} />
        </div>
      </div>

      {/* ... ç°æœ‰UI ... */}
    </div>
  )
}
```

**Gitæäº¤**:
```bash
git add app/dashboard/stats/page.tsx
git commit -m "feat(stats): add manual refresh button (ğŸŸ¢ GREEN)"
```

**é¢„è®¡è€—æ—¶**: 1å°æ—¶

---

## ğŸ¯ Task 4: é”™è¯¯æç¤ºä¼˜åŒ– (P1)

### ç›®æ ‡
ç»Ÿä¸€ä½¿ç”¨Toastï¼Œæä¾›å‹å¥½çš„é”™è¯¯æ¶ˆæ¯ã€‚

### ğŸŸ¢ GREEN: ç›´æ¥å®ç°

#### 4.1 ä¼˜åŒ–Hooké”™è¯¯æ¶ˆæ¯

**æ–‡ä»¶**: `hooks/use-stats.ts`

**ä¿®æ”¹**:
```typescript
export function useUsageStats(...) {
  return useQuery<UsageStatsResponse>({
    queryKey: ['usage-stats', params],
    queryFn: async () => {
      const response = await fetch(`/api/stats/usage?${params}`)
      if (!response.ok) {
-        throw new Error('Failed to fetch usage stats')
+        throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•')
      }
      return response.json()
    },
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
  })
}
```

#### 4.2 æ›¿æ¢alertä¸ºToast

**æ–‡ä»¶**: `components/stats/ExportDialog.tsx`

**ä¿®æ”¹**:
```typescript
import { useToast } from '@/components/ui/use-toast'

export function ExportDialog({ data, ... }) {
  const { toast } = useToast()

  const handleExport = () => {
    if (data.length === 0) {
-      alert('æš‚æ— æ•°æ®å¯å¯¼å‡º')
+      toast({
+        title: "æ— æ³•å¯¼å‡º",
+        description: "å½“å‰æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆé€‰æ‹©æ—¶é—´èŒƒå›´å’Œå¯†é’¥",
+        variant: "destructive"
+      })
      return
    }

    if (selectedFields.length === 0) {
-      alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­—æ®µ')
+      toast({
+        title: "æœªé€‰æ‹©å­—æ®µ",
+        description: "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­—æ®µè¿›è¡Œå¯¼å‡º",
+        variant: "destructive"
+      })
      return
    }

    executeExport(data, { format, fields: selectedFields, filename })

+    toast({
+      title: "å¯¼å‡ºæˆåŠŸ",
+      description: `å·²å¯¼å‡º${data.length}æ¡è®°å½•åˆ°${filename}.${format}`,
+    })

    setOpen(false)
  }

  // ...
}
```

**Gitæäº¤**:
```bash
git add hooks/use-stats.ts components/stats/ExportDialog.tsx
git commit -m "feat(stats): improve error messages and replace alert with toast (ğŸŸ¢ GREEN)"
```

**é¢„è®¡è€—æ—¶**: 1-2å°æ—¶

---

## ğŸ¯ Task 5: åŠ è½½è¿›åº¦æŒ‡ç¤ºå™¨ (P1)

### ç›®æ ‡
æä¾›è§†è§‰åé¦ˆï¼Œæ”¹å–„é•¿æ—¶é—´åŠ è½½çš„ç”¨æˆ·ä½“éªŒã€‚

### ğŸŸ¢ GREEN: ç›´æ¥å®ç°

**æ–‡ä»¶**: `app/dashboard/stats/page.tsx`

**ä¿®æ”¹**:
```typescript
import { Loader2 } from 'lucide-react'

export default function UsageStatsPage() {
  const { data, isLoading, isFetching, error, refetch } = useUsageStats(...)

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* æ ‡é¢˜å’Œæ“ä½œ */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <h1 className="text-3xl font-bold">ä½¿ç”¨ç»Ÿè®¡</h1>
          {/* åŠ è½½æŒ‡ç¤ºå™¨ - æ–°å¢ */}
          {isFetching && !isLoading && (
            <div className="flex items-center gap-2 text-muted-foreground text-sm">
              <Loader2 className="w-4 h-4 animate-spin" />
              <span>åˆ·æ–°ä¸­...</span>
            </div>
          )}
        </div>
        {/* ... æ“ä½œæŒ‰é’® ... */}
      </div>

      {/* ... ç°æœ‰UI ... */}
    </div>
  )
}
```

**Gitæäº¤**:
```bash
git add app/dashboard/stats/page.tsx
git commit -m "feat(stats): add loading progress indicator (ğŸŸ¢ GREEN)"
```

**é¢„è®¡è€—æ—¶**: 1å°æ—¶

---

## ğŸ“Š æ€»ä½“æ—¶é—´è§„åˆ’

### Day 1 (4-6å°æ—¶)
**ä¸Šåˆ** (3-4å°æ—¶):
- [ ] Task 1.1: ç¼–å†™è¶‹åŠ¿APIæµ‹è¯• (1h)
- [ ] Task 1.2-1.4: å®ç°è¶‹åŠ¿APIé›†æˆ (2-3h)

**ä¸‹åˆ** (1-2å°æ—¶):
- [ ] Task 1.5-1.6: é‡æ„è¶‹åŠ¿å·¥å…· (1-2h)

### Day 2 (4-5å°æ—¶)
**ä¸Šåˆ** (2-3å°æ—¶):
- [ ] Task 2.1-2.3: CRSé™çº§çŠ¶æ€æç¤º (1-2h)
- [ ] Task 3: æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½ (1h)

**ä¸‹åˆ** (2å°æ—¶):
- [ ] Task 4: é”™è¯¯æç¤ºä¼˜åŒ– (1-2h)
- [ ] Task 5: åŠ è½½è¿›åº¦æŒ‡ç¤ºå™¨ (1h)
- [ ] ç»¼åˆæµ‹è¯•å’Œæ–‡æ¡£æ›´æ–°

---

## âœ… P2.9å®Œæˆæ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- [ ] âœ… Statsé¡µé¢ä¸å†ä½¿ç”¨ä»»ä½•æ¨¡æ‹Ÿæ•°æ®
- [ ] âœ… è¶‹åŠ¿å›¾æ˜¾ç¤ºçœŸå®çš„CRS APIä½¿ç”¨æ•°æ®
- [ ] âœ… æ”¯æŒè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´çš„è¶‹åŠ¿æŸ¥è¯¢
- [ ] âœ… æ”¯æŒæŒ‰å¯†é’¥ç­›é€‰çš„è¶‹åŠ¿æŸ¥è¯¢
- [ ] âœ… CRSä¸å¯ç”¨æ—¶æœ‰æ˜ç¡®çš„UIæç¤ºï¼ˆAlertæ¨ªå¹…ï¼‰
- [ ] âœ… ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨åˆ·æ–°æ•°æ®ï¼ˆåˆ·æ–°æŒ‰é’®ï¼‰
- [ ] âœ… æ‰€æœ‰é”™è¯¯æç¤ºä½¿ç”¨Toastï¼ˆæ— alertï¼‰
- [ ] âœ… åŠ è½½çŠ¶æ€æ¸…æ™°å¯è§ï¼ˆè¿›åº¦æŒ‡ç¤ºå™¨ï¼‰

### æµ‹è¯•è¦†ç›–
- [ ] âœ… è¶‹åŠ¿APIæµ‹è¯•è¦†ç›–ç‡ > 90%
- [ ] âœ… CrsStatusAlertç»„ä»¶æµ‹è¯•è¦†ç›–ç‡ 100%
- [ ] âœ… æ‰€æœ‰ç°æœ‰æµ‹è¯•ä»ç„¶é€šè¿‡
- [ ] âœ… CRSé™çº§åœºæ™¯æœ‰æµ‹è¯•è¦†ç›–

### ç”¨æˆ·ä½“éªŒ
- [ ] âœ… è¶‹åŠ¿å›¾äº¤äº’æµç•…
- [ ] âœ… CRSçŠ¶æ€æç¤ºå‹å¥½æ˜ç¡®
- [ ] âœ… åˆ·æ–°åŠŸèƒ½ç›´è§‚æ˜“ç”¨
- [ ] âœ… é”™è¯¯æç¤ºå¯æ“ä½œ
- [ ] âœ… ç§»åŠ¨ç«¯å“åº”å¼æ­£å¸¸

### ä»£ç è´¨é‡
- [ ] âœ… éµå¾ªTDDæµç¨‹ï¼ˆRED â†’ GREEN â†’ REFACTORï¼‰
- [ ] âœ… Gitæäº¤è§„èŒƒï¼ˆåŒ…å«TDD phaseæ ‡è®°ï¼‰
- [ ] âœ… TypeScriptæ— é”™è¯¯
- [ ] âœ… ESLinté€šè¿‡
- [ ] âœ… æ— console.logè°ƒè¯•ä»£ç 

### æ–‡æ¡£æ›´æ–°
- [ ] âœ… æ›´æ–°`EXECUTION_PLAN.md`æ ‡è®°P2.9å®Œæˆ
- [ ] âœ… åˆ›å»º`P2.9_COMPLETION_SUMMARY.md`
- [ ] âœ… æ›´æ–°`NEXT_SESSION_PROMPT_V2.md`ä¸ºP2.10

---

## ğŸš€ å¼€å§‹å‘½ä»¤

```bash
# 1. ç¡®è®¤ä½ç½®å’Œåˆ†æ”¯
cd /Users/bypasser/claude-project/0930/claude-key-portal
git branch  # åº”åœ¨ feature/p2-usage-analytics

# 2. æ£€æŸ¥çŠ¶æ€
git status
git log --oneline -5

# 3. å¼€å§‹Task 1 - è¶‹åŠ¿APIé›†æˆ
# ğŸ”´ RED: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
mkdir -p tests/unit/app/api/stats
touch tests/unit/app/api/stats/usage-trend.test.ts

# 4. ç¼–å†™æµ‹è¯•å¹¶è¿è¡Œï¼ˆåº”å…¨éƒ¨å¤±è´¥ï¼‰
npm test -- usage-trend.test.ts

# 5. å®ç°åŠŸèƒ½...
```

---

## ğŸ“š å‚è€ƒèµ„æº

### ç›¸å…³æ–‡æ¡£
- `docs/P2.9_UI_UX_ANALYSIS.md` - UIé—®é¢˜åˆ†ææŠ¥å‘Š
- `docs/P2.3_COMPLETION_SUMMARY.md` - è¶‹åŠ¿APIé›†æˆç¤ºä¾‹
- `docs/CRS_API_INTEGRATION_SPECIFICATION.md` - CRS APIè§„èŒƒ

### APIç«¯ç‚¹
- `GET /admin/api-keys-usage-trend` - CRSè¶‹åŠ¿æ•°æ®
- `POST /web/auth/login` - CRSè®¤è¯

### ç»„ä»¶åº“
- Shadcn/ui Alertç»„ä»¶ (CRSçŠ¶æ€æç¤º)
- Shadcn/ui Toastç»„ä»¶ (é”™è¯¯æç¤º)
- Rechartså›¾è¡¨åº“ (è¶‹åŠ¿å›¾)

---

**è®¡åˆ’ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-10-10
**ä½œè€…**: Claude AI
**ä¸‹ä¸€æ­¥**: å¼€å§‹Task 1 - é›†æˆCRSè¶‹åŠ¿API
