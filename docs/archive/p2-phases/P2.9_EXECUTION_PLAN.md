# P2.9 UI/UX完善 - 详细执行计划

**创建时间**: 2025-10-10
**分支**: `feature/p2-usage-analytics`
**前置依赖**: P2.1-P2.8已完成
**预计工期**: 1.5-2天 (8-11小时)

---

## 📋 计划概览

### 目标
完善Stats页面的用户体验，移除所有模拟数据，集成真实CRS趋势API，添加降级提示和手动刷新功能。

### 核心原则
- ✅ 移除所有模拟数据（generateMockTimeSeriesData）
- ✅ 集成真实CRS Usage Trend API
- ✅ 提供CRS降级时的用户友好提示
- ✅ 优化错误处理和用户反馈
- ✅ 遵循TDD流程（🔴 RED → 🟢 GREEN → 🔵 REFACTOR）

### 任务拆分（按优先级）

| 任务 | 优先级 | 工作量 | TDD阶段 |
|------|--------|--------|---------|
| Task 1: 集成CRS趋势API | 🔴 P0 | 4-6h | 🔴 🟢 🔵 |
| Task 2: CRS降级状态提示 | 🔴 P0 | 1-2h | 🔴 🟢 |
| Task 3: 手动刷新功能 | 🟡 P1 | 1h | 🟢 |
| Task 4: 错误提示优化 | 🟡 P1 | 1-2h | 🟢 |
| Task 5: 加载进度指示器 | 🟡 P1 | 1h | 🟢 |

---

## 🎯 Task 1: 集成CRS使用趋势API (P0)

### 目标
移除`generateMockTimeSeriesData`模拟数据，集成真实的CRS Usage Trend API，显示实际的时间序列趋势图。

### 问题分析
**当前代码** (`app/dashboard/stats/page.tsx:76-82`):
```typescript
const timeSeriesData = useMemo<TimeSeriesDataPoint[]>(() => {
  if (!data?.keys) return []

  // TODO: 从后端获取已聚合的时间序列数据
  // 当前使用模拟数据
  return generateMockTimeSeriesData(7)
}, [data?.keys, selectedKeys])
```

**问题**:
- ❌ 图表显示虚假数据
- ❌ 违反项目核心原则（数据必须来自CRS）
- ❌ 无法实现真实的趋势分析

### 技术方案

#### 方案选择: 复用现有趋势API

**已实现的API** (P2.3完成):
- `GET /api/stats/usage` - 已集成CRS趋势数据
- `lib/infrastructure/external/crs-client.ts` - 已有`getUsageTrend()`方法

**实现路径**:
1. ✅ CRS Client已实现趋势获取（P2.3完成）
2. ✅ Usage API已缓存趋势数据（P2.8完成）
3. ❌ **缺失**: UI未使用趋势数据（仍用mock）

**解决方案**:
- 🎯 修改Usage API返回格式，包含趋势数据
- 🎯 更新`useUsageStats` Hook返回趋势字段
- 🎯 修改`page.tsx`使用真实趋势数据

---

### 🔴 RED: 编写测试

#### 1.1 创建趋势数据测试

**文件**: `tests/unit/app/api/stats/usage-trend.test.ts`

**测试用例**:
```typescript
describe('Usage API - Trend Data Integration', () => {
  describe('趋势数据获取', () => {
    it('应该返回时间序列趋势数据', async () => {
      // Given: 用户已登录，CRS返回趋势数据
      const mockTrend = [
        { date: '2024-01-01', tokens: 1000, calls: 10 },
        { date: '2024-01-02', tokens: 1500, calls: 15 },
      ]
      mockCrsClient.getUsageTrend.mockResolvedValue(mockTrend)

      // When: 调用API
      const response = await GET(mockRequest)
      const data = await response.json()

      // Then: 应包含趋势数据
      expect(data.trend).toEqual([
        { timestamp: '2024-01-01T00:00:00.000Z', tokens: 1000, requests: 10 },
        { timestamp: '2024-01-02T00:00:00.000Z', tokens: 1500, requests: 15 },
      ])
    })

    it('应该支持自定义日期范围', async () => {
      const mockRequest = createMockRequest({
        searchParams: {
          dateRange: 'custom',
          startDate: '2024-01-01',
          endDate: '2024-01-31',
        },
      })

      const response = await GET(mockRequest)
      const data = await response.json()

      expect(mockCrsClient.getUsageTrend).toHaveBeenCalledWith({
        startDate: '2024-01-01',
        endDate: '2024-01-31',
      })
    })

    it('应该支持按密钥筛选趋势', async () => {
      const mockRequest = createMockRequest({
        searchParams: {
          keyIds: 'key-1,key-2',
        },
      })

      const response = await GET(mockRequest)
      const data = await response.json()

      // 应调用CRS API获取每个密钥的趋势并聚合
      expect(data.trend).toBeDefined()
    })
  })

  describe('趋势数据缓存', () => {
    it('应该缓存趋势数据5分钟', async () => {
      const cacheKey = 'crs:trend:2024-01-01-2024-01-31'

      await GET(mockRequest)

      expect(mockCacheManager.set).toHaveBeenCalledWith(
        cacheKey,
        expect.any(Array),
        300 // 5分钟
      )
    })

    it('缓存命中时不应调用CRS API', async () => {
      mockCacheManager.get.mockResolvedValue([
        { timestamp: '2024-01-01', tokens: 1000, requests: 10 },
      ])

      await GET(mockRequest)

      expect(mockCrsClient.getUsageTrend).not.toHaveBeenCalled()
    })
  })

  describe('错误处理', () => {
    it('CRS不可用时应返回空数组', async () => {
      mockCrsClient.getUsageTrend.mockRejectedValue(
        new CrsUnavailableError('CRS unavailable')
      )

      const response = await GET(mockRequest)
      const data = await response.json()

      expect(data.trend).toEqual([])
      expect(data.crsWarning).toContain('趋势数据暂时不可用')
    })
  })
})
```

**预计**: 创建12个测试用例，全部失败（RED状态）

**Git提交**:
```bash
git add tests/unit/app/api/stats/usage-trend.test.ts
git commit -m "test(stats): add CRS trend data integration tests (🔴 RED)"
```

---

### 🟢 GREEN: 实现功能

#### 1.2 扩展Usage API返回趋势数据

**文件**: `app/api/stats/usage/route.ts`

**修改内容**:
```typescript
// 新增类型定义
interface TrendDataPoint {
  timestamp: string
  tokens: number
  requests: number
}

interface UsageResponse {
  summary: { ... }
  keys: KeyStats[]
  trend?: TrendDataPoint[]  // ← 新增
  crsDashboard?: { ... }
  crsWarning?: string
}

export async function GET(request: NextRequest) {
  // ... 现有代码 ...

  // 3. 获取趋势数据（新增）
  let trendData: TrendDataPoint[] = []
  try {
    const trendCacheKey = cacheManager.generateKey(
      'crs',
      'trend',
      `${startDate}-${endDate}`
    )

    // 尝试从缓存获取
    const cached = await cacheManager.get<any[]>(trendCacheKey)
    if (cached) {
      trendData = cached.map(transformTrendData)
    } else {
      // 从CRS获取趋势数据
      const crsTrend = await crsClient.getUsageTrend({
        startDate,
        endDate,
        keyIds: keyIdsFilter, // 支持密钥筛选
      })

      trendData = crsTrend.map(transformTrendData)

      // 缓存5分钟
      await cacheManager.set(
        trendCacheKey,
        crsTrend,
        cacheManager.getTTL('trend')
      )
    }
  } catch (error) {
    console.warn('[Usage API] Failed to fetch trend data:', error)
    warnings.push('趋势数据暂时不可用，请稍后刷新')
    // 继续执行，不抛出错误
  }

  return NextResponse.json({
    summary,
    keys,
    trend: trendData,  // ← 新增
    crsDashboard,
    crsWarning: warnings.length > 0 ? warnings.join('; ') : undefined,
  })
}

// 辅助函数：转换趋势数据格式
function transformTrendData(item: any): TrendDataPoint {
  return {
    timestamp: new Date(item.date).toISOString(),
    tokens: item.tokens || 0,
    requests: item.calls || 0,
  }
}
```

**涉及修改**:
- 新增`TrendDataPoint`类型
- 新增`trend`字段到响应
- 新增趋势数据获取和缓存逻辑
- 新增`transformTrendData`转换函数

---

#### 1.3 更新Hook返回趋势数据

**文件**: `hooks/use-stats.ts`

**修改内容**:
```typescript
export interface UsageStatsResponse {
  summary: { ... }
  keys: KeyStats[]
  trend?: TimeSeriesDataPoint[]  // ← 新增
  crsDashboard?: { ... }
  crsWarning?: string
}

// Hook保持不变，类型自动推断
```

---

#### 1.4 更新UI使用真实趋势数据

**文件**: `app/dashboard/stats/page.tsx`

**修改内容**:
```typescript
// 删除导入
- import { generateMockTimeSeriesData } from '@/lib/date-utils'

// 修改时间序列数据计算
const timeSeriesData = useMemo<TimeSeriesDataPoint[]>(() => {
-  if (!data?.keys) return []
-
-  // TODO: 从后端获取已聚合的时间序列数据
-  // 当前使用模拟数据
-  return generateMockTimeSeriesData(7)
+  // 使用API返回的真实趋势数据
+  return data?.trend || []
}, [data?.trend])
```

**关键变化**:
- ✅ 移除`generateMockTimeSeriesData`依赖
- ✅ 删除TODO注释
- ✅ 使用`data.trend`真实数据
- ✅ 依赖项从`[data?.keys, selectedKeys]`改为`[data?.trend]`

---

**Git提交**:
```bash
# 运行测试，确保通过
npm test -- usage-trend.test.ts

# 提交实现
git add app/api/stats/usage/route.ts hooks/use-stats.ts app/dashboard/stats/page.tsx
git commit -m "feat(stats): integrate CRS trend data and remove mock data (🟢 GREEN)"
```

---

### 🔵 REFACTOR: 优化代码

#### 1.5 提取趋势数据处理逻辑

**文件**: `app/api/stats/usage/trend-utils.ts` (新建)

**内容**:
```typescript
/**
 * 趋势数据处理工具
 */

import { crsClient } from '@/lib/infrastructure/external/crs-client'
import { cacheManager } from '@/lib/infrastructure/cache/cache-manager'

export interface TrendDataPoint {
  timestamp: string
  tokens: number
  requests: number
}

export interface FetchTrendOptions {
  startDate: string
  endDate: string
  keyIds?: string[]
}

/**
 * 获取趋势数据（带缓存）
 */
export async function fetchTrendData(
  options: FetchTrendOptions
): Promise<TrendDataPoint[]> {
  const { startDate, endDate, keyIds } = options

  // 生成缓存键
  const cacheKey = cacheManager.generateKey(
    'crs',
    'trend',
    `${startDate}-${endDate}${keyIds ? `-${keyIds.join(',')}` : ''}`
  )

  try {
    // 1. 尝试从缓存获取
    const cached = await cacheManager.get<any[]>(cacheKey)
    if (cached) {
      return cached.map(transformTrendData)
    }

    // 2. 从CRS获取
    const crsTrend = await crsClient.getUsageTrend({
      startDate,
      endDate,
      keyIds,
    })

    const transformed = crsTrend.map(transformTrendData)

    // 3. 缓存5分钟
    await cacheManager.set(cacheKey, crsTrend, cacheManager.getTTL('trend'))

    return transformed
  } catch (error) {
    console.warn('[Trend Utils] Failed to fetch trend data:', error)
    return []
  }
}

/**
 * 转换CRS趋势数据格式
 */
function transformTrendData(item: any): TrendDataPoint {
  return {
    timestamp: new Date(item.date).toISOString(),
    tokens: item.tokens || 0,
    requests: item.calls || 0,
  }
}

/**
 * 聚合多个密钥的趋势数据
 */
export function aggregateTrendData(
  trends: TrendDataPoint[][]
): TrendDataPoint[] {
  const aggregated = new Map<string, { tokens: number; requests: number }>()

  for (const trend of trends) {
    for (const point of trend) {
      const existing = aggregated.get(point.timestamp) || {
        tokens: 0,
        requests: 0,
      }
      aggregated.set(point.timestamp, {
        tokens: existing.tokens + point.tokens,
        requests: existing.requests + point.requests,
      })
    }
  }

  return Array.from(aggregated.entries())
    .map(([timestamp, data]) => ({
      timestamp,
      ...data,
    }))
    .sort((a, b) => a.timestamp.localeCompare(b.timestamp))
}
```

#### 1.6 简化Usage API

**文件**: `app/api/stats/usage/route.ts`

**修改**:
```typescript
import { fetchTrendData } from './trend-utils'

export async function GET(request: NextRequest) {
  // ... 现有代码 ...

  // 3. 获取趋势数据
  const trendData = await fetchTrendData({
    startDate,
    endDate,
    keyIds: keyIdsFilter,
  })

  if (trendData.length === 0 && keyIdsFilter) {
    warnings.push('趋势数据暂时不可用，请稍后刷新')
  }

  return NextResponse.json({
    summary,
    keys,
    trend: trendData,
    crsDashboard,
    crsWarning: warnings.length > 0 ? warnings.join('; ') : undefined,
  })
}
```

**优化点**:
- ✅ 提取`fetchTrendData`工具函数
- ✅ 简化主API逻辑
- ✅ 提高代码复用性

**Git提交**:
```bash
npm test -- usage-trend.test.ts

git add app/api/stats/usage/trend-utils.ts app/api/stats/usage/route.ts
git commit -m "refactor(stats): extract trend data utilities (🔵 REFACTOR)"
```

---

### Task 1 完成标准

- [x] ✅ 移除所有`generateMockTimeSeriesData`调用
- [x] ✅ 趋势图显示真实CRS数据
- [x] ✅ 支持自定义日期范围
- [x] ✅ 支持按密钥筛选趋势
- [x] ✅ 趋势数据缓存5分钟
- [x] ✅ CRS不可用时返回空数组 + 警告
- [x] ✅ 测试覆盖率 > 90%
- [x] ✅ 所有测试通过

**预计耗时**: 4-6小时

---

## 🎯 Task 2: CRS降级状态UI提示 (P0)

### 目标
当CRS不可用时，在UI显示明确的警告提示，告知用户当前数据来源和限制。

### 问题分析
**当前行为**:
- ✅ API返回`crsWarning`字段
- ❌ UI完全不显示警告
- ❌ 用户不知道CRS状态

**影响**:
- 用户困惑：为什么数据不准确？
- 信任度下降

---

### 🔴 RED: 编写测试

#### 2.1 创建CRS状态提示测试

**文件**: `tests/unit/components/stats/CrsStatusAlert.test.tsx` (新建)

**测试用例**:
```typescript
import { render, screen } from '@testing-library/react'
import { CrsStatusAlert } from '@/components/stats/CrsStatusAlert'

describe('CrsStatusAlert', () => {
  it('无警告时不显示', () => {
    render(<CrsStatusAlert warning={undefined} onRetry={() => {}} />)
    expect(screen.queryByTestId('crs-status-alert')).not.toBeInTheDocument()
  })

  it('有警告时显示Alert', () => {
    render(
      <CrsStatusAlert
        warning="CRS服务暂时不可用"
        onRetry={() => {}}
      />
    )

    expect(screen.getByTestId('crs-status-alert')).toBeInTheDocument()
    expect(screen.getByText(/CRS服务暂时不可用/)).toBeInTheDocument()
  })

  it('显示重试按钮', () => {
    render(
      <CrsStatusAlert
        warning="CRS unavailable"
        onRetry={() => {}}
      />
    )

    expect(screen.getByTestId('retry-crs-button')).toBeInTheDocument()
  })

  it('点击重试按钮触发回调', async () => {
    const onRetry = jest.fn()
    render(<CrsStatusAlert warning="error" onRetry={onRetry} />)

    const button = screen.getByTestId('retry-crs-button')
    await userEvent.click(button)

    expect(onRetry).toHaveBeenCalledTimes(1)
  })

  it('使用warning样式', () => {
    render(<CrsStatusAlert warning="error" onRetry={() => {}} />)

    const alert = screen.getByTestId('crs-status-alert')
    expect(alert).toHaveClass('border-warning')
  })
})
```

**Git提交**:
```bash
git add tests/unit/components/stats/CrsStatusAlert.test.tsx
git commit -m "test(stats): add CRS status alert tests (🔴 RED)"
```

---

### 🟢 GREEN: 实现功能

#### 2.2 创建CRS状态Alert组件

**文件**: `components/stats/CrsStatusAlert.tsx` (新建)

**内容**:
```typescript
'use client'

import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Button } from '@/components/ui/button'
import { AlertCircle, RefreshCw } from 'lucide-react'

interface CrsStatusAlertProps {
  /** CRS警告消息 */
  warning?: string
  /** 重试回调 */
  onRetry: () => void
  /** 是否正在重试 */
  retrying?: boolean
}

export function CrsStatusAlert({
  warning,
  onRetry,
  retrying = false,
}: CrsStatusAlertProps) {
  if (!warning) return null

  return (
    <Alert
      data-testid="crs-status-alert"
      variant="warning"
      className="mb-6 border-warning bg-warning/10"
    >
      <AlertCircle className="h-4 w-4" />
      <AlertTitle className="font-semibold">CRS服务暂时不可用</AlertTitle>
      <AlertDescription className="mt-2">
        <p className="mb-2">{warning}</p>
        <p className="text-sm text-muted-foreground mb-3">
          当前显示的是本地统计数据，部分功能（如实时趋势图、详细调用日志）暂时受限。
          系统会自动重试连接，您也可以手动刷新。
        </p>
        <Button
          size="sm"
          variant="outline"
          onClick={onRetry}
          disabled={retrying}
          data-testid="retry-crs-button"
        >
          <RefreshCw
            className={`w-4 h-4 mr-2 ${retrying ? 'animate-spin' : ''}`}
          />
          {retrying ? '连接中...' : '重试连接'}
        </Button>
      </AlertDescription>
    </Alert>
  )
}
```

#### 2.3 集成到Stats页面

**文件**: `app/dashboard/stats/page.tsx`

**修改**:
```typescript
import { CrsStatusAlert } from '@/components/stats/CrsStatusAlert'

export default function UsageStatsPage() {
  // ... 现有状态 ...

  // 数据获取
  const { data, isLoading, error, refetch } = useUsageStats(
    dateRange,
    customStartDate,
    customEndDate
  )

  // 处理重试
  const handleRetryCrs = async () => {
    await refetch()
  }

  // ... 骨架屏和错误状态 ...

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* 标题和操作 */}
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">使用统计</h1>
        <ExportDialog data={filteredKeys} />
      </div>

      {/* CRS状态提示 - 新增 */}
      <CrsStatusAlert
        warning={data?.crsWarning}
        onRetry={handleRetryCrs}
        retrying={isLoading}
      />

      {/* 概览卡片 */}
      {/* ... 现有UI ... */}
    </div>
  )
}
```

**Git提交**:
```bash
npm test -- CrsStatusAlert.test.tsx

git add components/stats/CrsStatusAlert.tsx app/dashboard/stats/page.tsx
git commit -m "feat(stats): add CRS status alert component (🟢 GREEN)"
```

---

### Task 2 完成标准

- [x] ✅ CRS警告消息显示在页面顶部
- [x] ✅ 使用Warning样式（黄色Alert）
- [x] ✅ 提供重试按钮
- [x] ✅ 重试时显示loading状态
- [x] ✅ 组件测试覆盖率 100%

**预计耗时**: 1-2小时

---

## 🎯 Task 3: 手动刷新功能 (P1)

### 目标
用户可以随时刷新数据，不受缓存限制。

### 🟢 GREEN: 直接实现（无需测试）

**文件**: `app/dashboard/stats/page.tsx`

**修改**:
```typescript
export default function UsageStatsPage() {
  const { data, isLoading, error, refetch, isFetching } = useUsageStats(...)

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* 标题和操作 */}
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">使用统计</h1>
        <div className="flex gap-2">
          {/* 刷新按钮 - 新增 */}
          <Button
            variant="outline"
            onClick={() => refetch()}
            disabled={isLoading || isFetching}
            data-testid="refresh-button"
          >
            <RefreshCw
              className={cn(
                'w-4 h-4 mr-2',
                isFetching && 'animate-spin'
              )}
            />
            刷新
          </Button>

          <ExportDialog data={filteredKeys} />
        </div>
      </div>

      {/* ... 现有UI ... */}
    </div>
  )
}
```

**Git提交**:
```bash
git add app/dashboard/stats/page.tsx
git commit -m "feat(stats): add manual refresh button (🟢 GREEN)"
```

**预计耗时**: 1小时

---

## 🎯 Task 4: 错误提示优化 (P1)

### 目标
统一使用Toast，提供友好的错误消息。

### 🟢 GREEN: 直接实现

#### 4.1 优化Hook错误消息

**文件**: `hooks/use-stats.ts`

**修改**:
```typescript
export function useUsageStats(...) {
  return useQuery<UsageStatsResponse>({
    queryKey: ['usage-stats', params],
    queryFn: async () => {
      const response = await fetch(`/api/stats/usage?${params}`)
      if (!response.ok) {
-        throw new Error('Failed to fetch usage stats')
+        throw new Error('获取统计数据失败，请检查网络连接或稍后重试')
      }
      return response.json()
    },
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
  })
}
```

#### 4.2 替换alert为Toast

**文件**: `components/stats/ExportDialog.tsx`

**修改**:
```typescript
import { useToast } from '@/components/ui/use-toast'

export function ExportDialog({ data, ... }) {
  const { toast } = useToast()

  const handleExport = () => {
    if (data.length === 0) {
-      alert('暂无数据可导出')
+      toast({
+        title: "无法导出",
+        description: "当前没有数据可导出，请先选择时间范围和密钥",
+        variant: "destructive"
+      })
      return
    }

    if (selectedFields.length === 0) {
-      alert('请至少选择一个字段')
+      toast({
+        title: "未选择字段",
+        description: "请至少选择一个字段进行导出",
+        variant: "destructive"
+      })
      return
    }

    executeExport(data, { format, fields: selectedFields, filename })

+    toast({
+      title: "导出成功",
+      description: `已导出${data.length}条记录到${filename}.${format}`,
+    })

    setOpen(false)
  }

  // ...
}
```

**Git提交**:
```bash
git add hooks/use-stats.ts components/stats/ExportDialog.tsx
git commit -m "feat(stats): improve error messages and replace alert with toast (🟢 GREEN)"
```

**预计耗时**: 1-2小时

---

## 🎯 Task 5: 加载进度指示器 (P1)

### 目标
提供视觉反馈，改善长时间加载的用户体验。

### 🟢 GREEN: 直接实现

**文件**: `app/dashboard/stats/page.tsx`

**修改**:
```typescript
import { Loader2 } from 'lucide-react'

export default function UsageStatsPage() {
  const { data, isLoading, isFetching, error, refetch } = useUsageStats(...)

  return (
    <div className="container mx-auto py-8 space-y-6">
      {/* 标题和操作 */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <h1 className="text-3xl font-bold">使用统计</h1>
          {/* 加载指示器 - 新增 */}
          {isFetching && !isLoading && (
            <div className="flex items-center gap-2 text-muted-foreground text-sm">
              <Loader2 className="w-4 h-4 animate-spin" />
              <span>刷新中...</span>
            </div>
          )}
        </div>
        {/* ... 操作按钮 ... */}
      </div>

      {/* ... 现有UI ... */}
    </div>
  )
}
```

**Git提交**:
```bash
git add app/dashboard/stats/page.tsx
git commit -m "feat(stats): add loading progress indicator (🟢 GREEN)"
```

**预计耗时**: 1小时

---

## 📊 总体时间规划

### Day 1 (4-6小时)
**上午** (3-4小时):
- [ ] Task 1.1: 编写趋势API测试 (1h)
- [ ] Task 1.2-1.4: 实现趋势API集成 (2-3h)

**下午** (1-2小时):
- [ ] Task 1.5-1.6: 重构趋势工具 (1-2h)

### Day 2 (4-5小时)
**上午** (2-3小时):
- [ ] Task 2.1-2.3: CRS降级状态提示 (1-2h)
- [ ] Task 3: 手动刷新功能 (1h)

**下午** (2小时):
- [ ] Task 4: 错误提示优化 (1-2h)
- [ ] Task 5: 加载进度指示器 (1h)
- [ ] 综合测试和文档更新

---

## ✅ P2.9完成标准

### 功能完整性
- [ ] ✅ Stats页面不再使用任何模拟数据
- [ ] ✅ 趋势图显示真实的CRS API使用数据
- [ ] ✅ 支持自定义日期范围的趋势查询
- [ ] ✅ 支持按密钥筛选的趋势查询
- [ ] ✅ CRS不可用时有明确的UI提示（Alert横幅）
- [ ] ✅ 用户可以手动刷新数据（刷新按钮）
- [ ] ✅ 所有错误提示使用Toast（无alert）
- [ ] ✅ 加载状态清晰可见（进度指示器）

### 测试覆盖
- [ ] ✅ 趋势API测试覆盖率 > 90%
- [ ] ✅ CrsStatusAlert组件测试覆盖率 100%
- [ ] ✅ 所有现有测试仍然通过
- [ ] ✅ CRS降级场景有测试覆盖

### 用户体验
- [ ] ✅ 趋势图交互流畅
- [ ] ✅ CRS状态提示友好明确
- [ ] ✅ 刷新功能直观易用
- [ ] ✅ 错误提示可操作
- [ ] ✅ 移动端响应式正常

### 代码质量
- [ ] ✅ 遵循TDD流程（RED → GREEN → REFACTOR）
- [ ] ✅ Git提交规范（包含TDD phase标记）
- [ ] ✅ TypeScript无错误
- [ ] ✅ ESLint通过
- [ ] ✅ 无console.log调试代码

### 文档更新
- [ ] ✅ 更新`EXECUTION_PLAN.md`标记P2.9完成
- [ ] ✅ 创建`P2.9_COMPLETION_SUMMARY.md`
- [ ] ✅ 更新`NEXT_SESSION_PROMPT_V2.md`为P2.10

---

## 🚀 开始命令

```bash
# 1. 确认位置和分支
cd /Users/bypasser/claude-project/0930/claude-key-portal
git branch  # 应在 feature/p2-usage-analytics

# 2. 检查状态
git status
git log --oneline -5

# 3. 开始Task 1 - 趋势API集成
# 🔴 RED: 创建测试文件
mkdir -p tests/unit/app/api/stats
touch tests/unit/app/api/stats/usage-trend.test.ts

# 4. 编写测试并运行（应全部失败）
npm test -- usage-trend.test.ts

# 5. 实现功能...
```

---

## 📚 参考资源

### 相关文档
- `docs/P2.9_UI_UX_ANALYSIS.md` - UI问题分析报告
- `docs/P2.3_COMPLETION_SUMMARY.md` - 趋势API集成示例
- `docs/CRS_API_INTEGRATION_SPECIFICATION.md` - CRS API规范

### API端点
- `GET /admin/api-keys-usage-trend` - CRS趋势数据
- `POST /web/auth/login` - CRS认证

### 组件库
- Shadcn/ui Alert组件 (CRS状态提示)
- Shadcn/ui Toast组件 (错误提示)
- Recharts图表库 (趋势图)

---

**计划版本**: v1.0
**创建时间**: 2025-10-10
**作者**: Claude AI
**下一步**: 开始Task 1 - 集成CRS趋势API
