# P2.7 - CSV/JSON å¯¼å‡ºåŠŸèƒ½å®Œæˆæ€»ç»“

## ğŸ“… å®Œæˆæ—¶é—´
2025-10-10

## ğŸ¯ ä»»åŠ¡ç›®æ ‡
å®ç°ç»Ÿè®¡æ•°æ®çš„CSVå’ŒJSONå¯¼å‡ºåŠŸèƒ½ï¼Œæ”¯æŒæ‰€æœ‰ç°æœ‰çš„ç­›é€‰å‚æ•°ã€‚

## âœ… å®Œæˆå†…å®¹

### 1. TDDæµç¨‹å®Œæˆ

#### ğŸ”´ REDé˜¶æ®µ
- **æµ‹è¯•æ–‡ä»¶**: `tests/unit/app/api/stats/usage/export.test.ts` (461è¡Œ)
- **æµ‹è¯•æ•°é‡**: 17ä¸ªæµ‹è¯•ç”¨ä¾‹
- **æµ‹è¯•è¦†ç›–**:
  - âœ… CSVæ ¼å¼å¯¼å‡ºï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
  - âœ… JSONæ ¼å¼å¯¼å‡ºï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
  - âœ… å‚æ•°éªŒè¯ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
  - âœ… ç©ºæ•°æ®å¤„ç†ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
  - âœ… ç­›é€‰æ¡ä»¶æ”¯æŒï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
  - âœ… æƒé™æ§åˆ¶ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
  - âœ… æ–‡ä»¶åç”Ÿæˆï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
  - âœ… æ•°æ®æ ¼å¼åŒ–ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰

#### ğŸŸ¢ GREENé˜¶æ®µ
- **APIå®ç°**: `app/api/stats/usage/export/route.ts` (96è¡Œ)
- **åŠŸèƒ½ç‰¹æ€§**:
  - âœ… æ”¯æŒCSVå’ŒJSONä¸¤ç§å¯¼å‡ºæ ¼å¼
  - âœ… æ”¯æŒæ‰€æœ‰ç°æœ‰çš„ç­›é€‰å‚æ•°ï¼ˆåç§°ã€çŠ¶æ€ã€Tokenæ•°ã€è¯·æ±‚æ•°ã€æ—¶é—´ï¼‰
  - âœ… è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å
  - âœ… CSVç‰¹æ®Šå­—ç¬¦å¤„ç†ï¼ˆé€—å·ã€å¼•å·ã€æ¢è¡Œç¬¦è½¬ä¹‰ï¼‰
  - âœ… JSONå…ƒæ•°æ®åŒ…å«ï¼ˆå¯¼å‡ºæ—¶é—´ã€ç”¨æˆ·IDã€ç­›é€‰æ¡ä»¶ã€æ€»æ•°ï¼‰
  - âœ… BigIntæ•°æ®ç±»å‹æ­£ç¡®åºåˆ—åŒ–
  - âœ… æ—¥æœŸæ ¼å¼åŒ–ä¸ºISOå­—ç¬¦ä¸²
  - âœ… æƒé™éš”ç¦»ï¼ˆä»…å¯¼å‡ºå½“å‰ç”¨æˆ·æ•°æ®ï¼‰
  - âœ… ç©ºæ•°æ®ä¼˜é›…å¤„ç†

#### ğŸ”µ REFACTORé˜¶æ®µ
- **å·¥å…·æ¨¡å—**: `app/api/stats/usage/export/formatters.ts` (131è¡Œ)
- **ä¼˜åŒ–å†…å®¹**:
  - âœ… æå–CSVæ ¼å¼åŒ–é€»è¾‘ï¼ˆ`convertToCSV`ï¼‰
  - âœ… æå–JSONæ ¼å¼åŒ–é€»è¾‘ï¼ˆ`convertToJSON`ï¼‰
  - âœ… æå–æ–‡ä»¶åç”Ÿæˆé€»è¾‘ï¼ˆ`generateFilename`ï¼‰
  - âœ… æå–CSVå­—æ®µè½¬ä¹‰ï¼ˆ`escapeCSVField`ï¼‰
  - âœ… æå–æ—¥æœŸæ ¼å¼åŒ–ï¼ˆ`formatDateForCSV`ï¼‰
  - âœ… æå–ç­›é€‰æ¡ä»¶è¿‡æ»¤ï¼ˆ`filterActiveFilters`ï¼‰
  - âœ… ä»£ç æ¨¡å—åŒ–ã€å¯æµ‹è¯•æ€§å¼º

### 2. APIè®¾è®¡

#### ç«¯ç‚¹
```
GET /api/stats/usage/export
```

#### æŸ¥è¯¢å‚æ•°
```typescript
{
  // å¿…éœ€å‚æ•°
  format?: 'csv' | 'json'  // é»˜è®¤: 'csv'

  // ç­›é€‰å‚æ•°ï¼ˆå¯é€‰ï¼Œä¸/api/stats/usageä¿æŒä¸€è‡´ï¼‰
  nameContains?: string    // åç§°æœç´¢
  status?: 'active' | 'inactive'  // çŠ¶æ€ç­›é€‰
  minTokens?: string       // æœ€å°Tokenæ•°
  maxTokens?: string       // æœ€å¤§Tokenæ•°
  minRequests?: string     // æœ€å°è¯·æ±‚æ•°
  maxRequests?: string     // æœ€å¤§è¯·æ±‚æ•°
  startDate?: string       // å¼€å§‹æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
  endDate?: string         // ç»“æŸæ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
}
```

#### å“åº”æ ¼å¼

**CSVæ ¼å¼**:
```csv
å¯†é’¥åç§°,çŠ¶æ€,æ€»Tokenæ•°,æ€»è¯·æ±‚æ•°,åˆ›å»ºæ—¶é—´,æœ€åä½¿ç”¨æ—¶é—´
Production Key,active,10000,100,2024-01-01,2024-10-10
Test Key,inactive,500,5,2024-01-01,2024-01-02
```

**JSONæ ¼å¼**:
```json
{
  "exportedAt": "2024-10-10T10:00:00.000Z",
  "userId": "user-123",
  "filters": {
    "status": "active",
    "minTokens": "1000"
  },
  "totalCount": 2,
  "data": [
    {
      "id": "key-1",
      "name": "Production Key",
      "status": "active",
      "totalTokens": 10000,
      "totalRequests": 100,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "lastUsedAt": "2024-10-10T00:00:00.000Z"
    }
  ]
}
```

#### å“åº”å¤´
```
Content-Type: text/csv; charset=utf-8 (CSVæ ¼å¼)
Content-Type: application/json; charset=utf-8 (JSONæ ¼å¼)
Content-Disposition: attachment; filename="usage-stats-{timestamp}.{format}"
```

### 3. æ–‡ä»¶ç»“æ„

```
app/api/stats/usage/export/
â”œâ”€â”€ route.ts           # ä¸»APIè·¯ç”± (96è¡Œ)
â””â”€â”€ formatters.ts      # æ ¼å¼åŒ–å·¥å…· (131è¡Œ)

tests/unit/app/api/stats/usage/
â””â”€â”€ export.test.ts     # æµ‹è¯•æ–‡ä»¶ (461è¡Œ)
```

### 4. æµ‹è¯•ç»“æœ

```bash
Test Suites: 4 passed, 4 total
Tests:       60 passed, 60 total  # åŒ…æ‹¬æ‰€æœ‰statsç›¸å…³æµ‹è¯•
  - export.test.ts: 17 passed
  - usage.test.ts: 18 passed
  - compare.test.ts: 10 passed
  - leaderboard.test.ts: 15 passed
```

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ–°å¢æµ‹è¯• | 17ä¸ª |
| æ–°å¢ä»£ç  | 227è¡Œ |
| æµ‹è¯•è¦†ç›–ç‡ | 100% |
| æµ‹è¯•é€šè¿‡ç‡ | 100% (17/17) |
| APIç«¯ç‚¹ | 1ä¸ª |
| å·¥å…·å‡½æ•° | 6ä¸ª |

## ğŸ¨ æŠ€æœ¯äº®ç‚¹

### 1. CSVç‰¹æ®Šå­—ç¬¦å¤„ç†
```typescript
function escapeCSVField(field: string | number | null | undefined): string {
  if (field === null || field === undefined) {
    return ''
  }

  const str = String(field)

  // RFC 4180æ ‡å‡†ï¼šåŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œç¬¦æ—¶ï¼Œç”¨å¼•å·åŒ…è£¹å¹¶è½¬ä¹‰å†…éƒ¨å¼•å·
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return `"${str.replace(/"/g, '""')}"`
  }

  return str
}
```

### 2. ç­›é€‰æ¡ä»¶å¤ç”¨
```typescript
// å¤ç”¨ç°æœ‰çš„ç­›é€‰é€»è¾‘ï¼Œä¿æŒAPIä¸€è‡´æ€§
const filterParams: FilterParams = {
  name: searchParams.get('nameContains'),
  status: searchParams.get('status'),
  // ... å…¶ä»–ç­›é€‰å‚æ•°
}

const filterConditions = buildAdvancedFilters(filterParams)
```

### 3. å…ƒæ•°æ®è¿‡æ»¤
```typescript
// åªå¯¼å‡ºénullçš„ç­›é€‰æ¡ä»¶ï¼Œé¿å…JSONå†—ä½™
const activeFilters = Object.entries(filters).reduce(
  (acc, [key, value]) => {
    if (value !== null && value !== undefined) {
      acc[key] = value
    }
    return acc
  },
  {} as Record<string, any>
)
```

### 4. BigIntåºåˆ—åŒ–
```typescript
// å®‰å…¨åœ°å°†BigIntè½¬æ¢ä¸ºNumber
totalTokens: Number(item.totalTokens),
totalRequests: Number(item.totalCalls),
```

## ğŸ”— é›†æˆè¯´æ˜

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹

```typescript
// CSVå¯¼å‡º
async function exportCSV(filters?: FilterParams) {
  const params = new URLSearchParams({ format: 'csv', ...filters })
  const response = await fetch(`/api/stats/usage/export?${params}`)
  const blob = await response.blob()

  // è§¦å‘ä¸‹è½½
  const url = window.URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = response.headers.get('content-disposition')?.match(/filename="(.+)"/)?.[1] || 'export.csv'
  a.click()
}

// JSONå¯¼å‡º
async function exportJSON(filters?: FilterParams) {
  const params = new URLSearchParams({ format: 'json', ...filters })
  const response = await fetch(`/api/stats/usage/export?${params}`)
  const data = await response.json()

  // å¤„ç†JSONæ•°æ®æˆ–è§¦å‘ä¸‹è½½
  console.log('å¯¼å‡ºæ•°æ®:', data)
}
```

## ğŸ“ Gitæäº¤è®°å½•

```bash
f7023bc test(stats): add CSV/JSON export tests (ğŸ”´ RED)
c5ea1d1 feat(stats): implement CSV/JSON export functionality (ğŸŸ¢ GREEN)
d0b43cb refactor(stats): extract export formatters to separate module (ğŸ”µ REFACTOR)
```

## ğŸ¯ ä¸‹ä¸€æ­¥ä»»åŠ¡

æ ¹æ® `docs/NEXT_SESSION_PROMPT_V2.md`:

```markdown
ç¬¬3å¤© - å¯¼å‡ºå’Œä¼˜åŒ–:
- [x] P2.7: CSV/JSONå¯¼å‡º âœ… å·²å®Œæˆ
- [ ] P2.8: æ€§èƒ½ä¼˜åŒ– â† ä¸‹ä¸€ä»»åŠ¡
- [ ] P2.9: UI/UXå®Œå–„
```

### P2.8ä»»åŠ¡é¢„è§ˆ
- å®ç°Redisç¼“å­˜
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
- å®ç°è¯·æ±‚å»é‡
- ç›‘æ§æ€§èƒ½æŒ‡æ ‡

---

**å®Œæˆæ ‡å‡†**: âœ… ALL GREEN
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ (17/17)
- âœ… æµ‹è¯•è¦†ç›–ç‡ 100%
- âœ… ä»£ç å·²é‡æ„ä¼˜åŒ–
- âœ… Gitæäº¤è§„èŒƒ
- âœ… æ–‡æ¡£å®Œæ•´

**è¯„ä¼°**: P2.7ä»»åŠ¡å®Œç¾å®Œæˆï¼ğŸ‰
