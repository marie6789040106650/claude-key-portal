# P3.2 开发会话提示词

> **会话目标**: P3.2 核心功能开发 - 密钥操作完善
> **当前分支**: `feature/p3.2-core-features`
> **上一阶段**: P3.1 Day 1 完成 (测试通过率 82.3%)
> **创建时间**: 2025-10-10

---

## 🎯 会话目标

开始 **P3.2 - 核心功能补全** 阶段，重点实现密钥管理的关键操作功能。

---

## 📊 当前状态

### 已完成 ✅
- **P3.1 Day 1**: 测试修复完成
  - 测试通过率: 52% → 82.3%
  - Mock配置统一（fetch, clipboard, redis）
  - JWT配置验证修复
  - 未实现功能合理跳过
  - 已合并到 develop 分支

### 当前分支 🌿
```bash
feature/p3.2-core-features (刚创建)
```

---

## 🚀 本次会话任务

### Task 1: 密钥启用/禁用功能 ⭐ 优先

**需求描述**:
- 用户可以临时禁用密钥（不删除）
- 禁用的密钥无法使用，但数据保留
- 可以随时重新启用

**技术实现**:
```typescript
// 1. 数据库Schema更新
model ApiKey {
  // ... 现有字段
  isActive: Boolean @default(true)  // 新增
  disabledAt: DateTime?             // 禁用时间
  disabledReason: String?          // 禁用原因（可选）
}

// 2. API端点
PUT /api/keys/:id/status
Request: { isActive: boolean, reason?: string }
Response: { success: boolean, key: ApiKey }

// 3. CRS同步
// 需要调用 CRS Admin API 同步状态
// 如果CRS不支持，在Portal层控制访问
```

**TDD流程**:
```bash
# 🔴 RED: 先写测试
test(key): add enable/disable key tests (🔴 RED)

# 🟢 GREEN: 实现功能
feat(key): implement key enable/disable (🟢 GREEN)

# 🔵 REFACTOR: 优化代码
refactor(key): optimize status update logic (🔵 REFACTOR)
```

**验收标准**:
- [ ] 数据库迁移脚本完成
- [ ] API端点测试通过
- [ ] CRS集成验证（如果支持）
- [ ] UI按钮正常工作
- [ ] 禁用状态正确显示

---

### Task 2: 密钥重命名功能

**需求描述**:
- 用户可以修改密钥名称
- 名称不能与现有密钥重复
- 需要同步到 CRS

**技术实现**:
```typescript
// API端点
PUT /api/keys/:id/rename
Request: { name: string }
Response: { success: boolean, key: ApiKey }

// 验证逻辑
- 名称不能为空
- 名称不能重复（同一用户下）
- 长度限制: 1-50字符
```

**TDD流程**:
```bash
# 🔴 RED
test(key): add key rename tests (🔴 RED)

# 🟢 GREEN
feat(key): implement key rename (🟢 GREEN)

# 🔵 REFACTOR
refactor(key): extract name validation (🔵 REFACTOR)
```

---

### Task 3: 批量操作功能 (可选)

**需求描述**:
- 批量禁用密钥
- 批量删除密钥
- 批量更新标签

**技术实现**:
```typescript
// API端点
POST /api/keys/batch
Request: {
  action: 'disable' | 'delete' | 'update_tags',
  keyIds: string[],
  params?: any
}
Response: {
  success: boolean,
  results: { keyId: string, success: boolean, error?: string }[]
}
```

**注意**: 如果时间紧张，此功能可以延后到 P3.3

---

## 📝 开发流程

### 1. 环境准备
```bash
# 确认分支
git branch --show-current  # 应该是 feature/p3.2-core-features

# 确认测试状态
npm test

# 启动开发服务器
npm run dev
```

### 2. 开发顺序
```bash
# Day 1: 密钥启用/禁用
1. 🔴 编写测试用例
2. 🟢 实现数据库迁移
3. 🟢 实现API端点
4. 🟢 实现UI组件
5. 🔵 重构优化
6. ✅ 提交代码

# Day 2: 密钥重命名
1. 🔴 编写测试用例
2. 🟢 实现API端点
3. 🟢 实现UI表单
4. 🔵 重构优化
5. ✅ 提交代码

# Day 3: 批量操作（可选）
如果前两个任务完成顺利，考虑实现批量操作
```

### 3. 提交规范
```bash
# 测试
git commit -m "test(key): add key status tests (🔴 RED)"

# 功能实现
git commit -m "feat(key): implement key enable/disable (🟢 GREEN)"

# 重构
git commit -m "refactor(key): optimize status update logic (🔵 REFACTOR)"

# 数据库
git commit -m "chore(db): add isActive field to ApiKey"
```

---

## 🔍 技术关键点

### 1. CRS集成确认

**重要**: 需要先验证 CRS 是否支持密钥启用/禁用

```bash
# 查看 CRS API 文档
cat docs/CRS_API_INTEGRATION_SPECIFICATION.md

# 如果不支持，在Portal层控制
# - 数据库标记 isActive
# - API层拦截禁用的密钥请求
```

### 2. 数据库迁移

```typescript
// prisma/migrations/xxx_add_key_status/migration.sql
ALTER TABLE "ApiKey" ADD COLUMN "isActive" BOOLEAN DEFAULT true;
ALTER TABLE "ApiKey" ADD COLUMN "disabledAt" TIMESTAMP;
ALTER TABLE "ApiKey" ADD COLUMN "disabledReason" TEXT;

// 更新 schema.prisma
model ApiKey {
  // ... 现有字段
  isActive       Boolean   @default(true)
  disabledAt     DateTime?
  disabledReason String?
}
```

### 3. UI组件设计

```typescript
// 密钥列表页面
<KeyListItem>
  <StatusBadge isActive={key.isActive} />
  <DropdownMenu>
    {key.isActive ? (
      <MenuItem onClick={disableKey}>禁用</MenuItem>
    ) : (
      <MenuItem onClick={enableKey}>启用</MenuItem>
    )}
  </DropdownMenu>
</KeyListItem>
```

---

## 📚 参考文档

### 核心文档（必读）
1. **DDD_TDD_GIT_STANDARD.md** - 开发标准
2. **P3_EXECUTION_PLAN.md** - P3阶段总体规划
3. **API_MAPPING_SPECIFICATION.md** - API规范
4. **DATABASE_SCHEMA.md** - 数据模型

### CRS集成文档
- **docs/CRS_API_INTEGRATION_SPECIFICATION.md** - CRS API规范
- **docs/CRS_API_VERIFICATION.md** - CRS API验证结果

### 前端参考
- **prototypes/keys.html** - 密钥列表页面原型

---

## ✅ 验收清单

### 功能完整性
- [ ] 密钥启用/禁用API实现
- [ ] 密钥重命名API实现
- [ ] UI操作按钮正常工作
- [ ] 状态变化正确反映

### 代码质量
- [ ] TDD流程完整（RED → GREEN → REFACTOR）
- [ ] 测试覆盖率 > 80%
- [ ] TypeScript无错误
- [ ] ESLint通过

### CRS集成
- [ ] 验证CRS是否支持状态同步
- [ ] 实现降级策略（如果不支持）
- [ ] 错误处理完善

### 文档更新
- [ ] API文档更新
- [ ] 数据库Schema文档更新
- [ ] 功能使用说明

---

## 🎯 成功标准

### 用户价值
- ✅ 用户可以临时禁用密钥
- ✅ 用户可以修改密钥名称
- ✅ 操作简单直观
- ✅ 状态变化清晰可见

### 技术质量
- ✅ 代码符合DDD分层架构
- ✅ 测试覆盖完整
- ✅ CRS集成稳定
- ✅ 错误处理友好

---

## 🚀 开始命令

```bash
# 1. 确认环境
git branch --show-current  # feature/p3.2-core-features
npm test                   # 验证测试基础

# 2. 开始开发
# 从 Task 1 开始: 密钥启用/禁用功能

# 3. 完成后标记
claude-monitor done "P3.2 Task 1完成 - 密钥启用/禁用功能"
```

---

## 💡 开发建议

### 优先级排序
1. **最高优先**: 密钥启用/禁用（核心功能）
2. **高优先**: 密钥重命名（常用功能）
3. **中优先**: 批量操作（锦上添花）

### 时间分配
- Day 1: 启用/禁用功能（4-6小时）
- Day 2: 重命名功能（2-4小时）
- Day 3: 批量操作（可选）

### 风险提示
- ⚠️ CRS可能不支持状态同步，需要做好降级方案
- ⚠️ 批量操作可能涉及CRS并发限制
- ⚠️ 确保禁用的密钥确实无法使用

---

**准备好开始了吗？** 🚀

执行: `npm test` 确认测试基础，然后开始 **Task 1: 密钥启用/禁用功能**！

---

_"聚焦核心功能，避免过度设计！"_
