# Sprint 12 - Phase 5: 🟢 GREEN 阶段 Todolist

**创建时间**: 2025-10-04
**阶段**: 密钥管理页面实现（GREEN）
**目标**: 实现所有组件使 Phase 4 的 73 个测试通过

---

## 🎯 阶段目标

实现密钥管理功能的所有组件和页面，使 Phase 4 编写的 73 个测试全部通过：
- ✅ KeysTable 组件（25 个测试）
- ✅ KeyForm 组件（30 个测试）
- ✅ KeysPage 页面（18 个测试）

---

## 📋 任务列表

### 任务 1: 创建 KeysTable 组件

#### 1.1 创建组件文件和基础结构
- [ ] 创建 `components/keys/KeysTable.tsx`
- [ ] 定义组件 Props 接口
- [ ] 实现基础表格布局（使用 shadcn/ui Table）
- [ ] 运行测试：基础渲染测试（5个）应通过

#### 1.2 实现排序功能
- [ ] 添加列头点击排序逻辑
- [ ] 实现升序/降序切换
- [ ] 添加排序指示器图标
- [ ] 实现保持选中状态的排序
- [ ] 运行测试：排序功能测试（5个）应通过

#### 1.3 实现过滤功能
- [ ] 添加状态过滤器组件
- [ ] 实现搜索功能（按名称）
- [ ] 显示过滤结果计数
- [ ] 添加清除过滤按钮
- [ ] 运行测试：过滤功能测试（5个）应通过

#### 1.4 实现分页功能
- [ ] 添加分页控件
- [ ] 实现翻页逻辑
- [ ] 显示页码信息
- [ ] 处理首页/末页禁用状态
- [ ] 运行测试：分页功能测试（5个）应通过

#### 1.5 实现操作按钮
- [ ] 添加编辑、删除、复制按钮
- [ ] 实现按钮点击回调
- [ ] 添加复制成功提示
- [ ] 实现空状态和加载状态
- [ ] 实现错误状态和重试
- [ ] 运行测试：操作按钮测试（5个）应通过

#### 1.6 验证 KeysTable 所有测试通过
- [ ] 运行 `npm test -- KeysTable.test.tsx`
- [ ] 确认 25 个测试全部通过（100%）

---

### 任务 2: 创建 KeyForm 组件

#### 2.1 创建组件文件和表单结构
- [ ] 创建 `components/keys/KeyForm.tsx`
- [ ] 定义组件 Props 接口
- [ ] 使用 React Hook Form + Zod 设置表单
- [ ] 添加所有表单字段（name, description, rateLimit, expiresAt）
- [ ] 运行测试：表单渲染测试前 5 个应通过

#### 2.2 实现表单验证
- [ ] 配置 Zod schema（必填、长度、格式）
- [ ] 添加字段帮助文本
- [ ] 实现实时验证（onBlur）
- [ ] 显示验证错误提示
- [ ] 运行测试：字段验证测试（10个）应通过

#### 2.3 实现创建/编辑模式
- [ ] 添加 mode prop（create/edit）
- [ ] 实现表单预填充（编辑模式）
- [ ] 动态标题和按钮文本
- [ ] 处理字段禁用逻辑
- [ ] 运行测试：创建/编辑模式测试（5个）应通过

#### 2.4 集成 API 调用
- [ ] 实现创建密钥 API 调用（POST /api/keys）
- [ ] 实现编辑密钥 API 调用（PUT /api/keys/[id]）
- [ ] 添加加载状态和禁用逻辑
- [ ] 处理 API 错误和网络错误
- [ ] 实现成功后回调和表单重置
- [ ] 运行测试：API 集成测试（10个）应通过

#### 2.5 完善 UI 和交互
- [ ] 添加取消按钮和回调
- [ ] 实现加载状态 UI
- [ ] 添加错误提示 Toast
- [ ] 优化表单布局和样式
- [ ] 运行测试：表单渲染测试剩余 5 个应通过

#### 2.6 验证 KeyForm 所有测试通过
- [ ] 运行 `npm test -- KeyForm.test.tsx`
- [ ] 确认 30 个测试全部通过（100%）

---

### 任务 3: 创建 KeysPage 页面

#### 3.1 创建页面文件和布局
- [ ] 创建 `app/dashboard/keys/page.tsx`
- [ ] 实现页面布局（标题、搜索、创建按钮）
- [ ] 集成 KeysTable 组件
- [ ] 运行测试：页面渲染测试（5个）应通过

#### 3.2 实现数据加载
- [ ] 使用 React Query 获取密钥列表
- [ ] 实现加载状态（骨架屏）
- [ ] 实现错误状态和重试
- [ ] 运行测试：数据加载测试（5个）应通过

#### 3.3 实现创建密钥流程
- [ ] 添加创建按钮点击处理
- [ ] 集成 KeyForm 对话框（创建模式）
- [ ] 实现创建成功后刷新列表
- [ ] 处理创建失败错误提示
- [ ] 运行测试：创建密钥流程测试（4个）应通过

#### 3.4 实现编辑密钥流程
- [ ] 添加编辑按钮点击处理
- [ ] 集成 KeyForm 对话框（编辑模式）
- [ ] 实现编辑成功后更新列表
- [ ] 运行测试：编辑密钥流程测试（3个）应通过

#### 3.5 实现删除密钥流程
- [ ] 添加删除确认对话框
- [ ] 实现删除 API 调用
- [ ] 处理删除成功后更新列表
- [ ] 处理取消和错误
- [ ] 运行测试：删除密钥流程测试（5个）应通过

#### 3.6 实现搜索和过滤
- [ ] 添加搜索输入框
- [ ] 添加状态过滤器
- [ ] 实现搜索和过滤逻辑
- [ ] 实现清除搜索
- [ ] 运行测试：搜索和过滤测试（3个）应通过

#### 3.7 验证 KeysPage 所有测试通过
- [ ] 运行 `npm test -- KeysPage.test.tsx`
- [ ] 确认 18 个测试全部通过（100%）

---

### 任务 4: 整体验证

#### 4.1 运行所有密钥管理测试
- [ ] 运行 `npm test -- KeysTable KeyForm KeysPage`
- [ ] 确认 73 个测试全部通过（100%）

#### 4.2 TypeScript 检查
- [ ] 运行 `npx tsc --noEmit`
- [ ] 确认无 TypeScript 错误

#### 4.3 ESLint 检查
- [ ] 运行 `npm run lint`
- [ ] 修复所有 ESLint 错误和警告

#### 4.4 手动测试
- [ ] 启动开发服务器 `npm run dev`
- [ ] 访问 `/dashboard/keys` 页面
- [ ] 测试创建密钥功能
- [ ] 测试编辑密钥功能
- [ ] 测试删除密钥功能
- [ ] 测试搜索和过滤功能
- [ ] 测试响应式布局（移动端）

---

### 任务 5: 提交和文档

#### 5.1 Git 提交
- [ ] 运行 `git add .`
- [ ] 提交更改：`git commit -m "feat: implement key management UI (Sprint 12 Phase 5 🟢 GREEN)"`
- [ ] 创建提交信息（包含功能清单和测试结果）

#### 5.2 创建 Phase 5 总结文档
- [ ] 创建 `docs/SPRINT_12_PHASE_5_SUMMARY.md`
- [ ] 记录实现的功能
- [ ] 记录测试结果
- [ ] 记录遇到的问题和解决方案

#### 5.3 创建 Phase 6 Todolist
- [ ] 创建 `docs/SPRINT_12_PHASE_6_TODOLIST.md`
- [ ] 规划重构和优化任务

---

## 📊 预期结果

### 测试统计
- **KeysTable**: 25/25 通过（100%）
- **KeyForm**: 30/30 通过（100%）
- **KeysPage**: 18/18 通过（100%）
- **总计**: 73/73 通过（100%）

### 代码统计
- **新建文件**: 3 个
  - `components/keys/KeysTable.tsx`
  - `components/keys/KeyForm.tsx`
  - `app/dashboard/keys/page.tsx`
- **预计代码量**: ~800 行

### 功能清单
- ✅ 密钥列表展示（表格、分页、排序）
- ✅ 密钥搜索和过滤
- ✅ 创建新密钥（代理 CRS）
- ✅ 编辑密钥信息
- ✅ 删除密钥（带确认）
- ✅ 复制密钥到剪贴板
- ✅ 加载状态和错误处理
- ✅ 响应式设计

---

## 🛠️ 技术要点

### 使用的库和工具
- **UI 组件**: shadcn/ui (Table, Dialog, Form, Button, Input, Select)
- **表单管理**: React Hook Form
- **表单验证**: Zod
- **数据获取**: React Query (@tanstack/react-query)
- **API 调用**: fetch API
- **状态管理**: React useState + React Query cache

### 关键实现点
1. **KeysTable 排序**:
   - 使用 `useMemo` 缓存排序结果
   - 支持多列排序和升降序切换

2. **KeyForm 验证**:
   - Zod schema 完整验证
   - 实时错误提示
   - 自定义错误消息

3. **KeysPage 状态管理**:
   - React Query 管理服务器状态
   - Optimistic updates 提升体验
   - Error boundaries 处理错误

4. **CRS API 集成**:
   - 通过 `/api/keys` 代理 CRS Admin API
   - 完整的错误处理和降级策略
   - 加载状态和重试机制

---

## ⚠️ 注意事项

1. **遵循 TDD 流程**:
   - 每实现一部分功能，立即运行对应测试
   - 确保测试通过后再继续下一步
   - 不要跳过任何测试

2. **代码质量**:
   - 保持组件简洁，单一职责
   - 使用 TypeScript 严格类型
   - 添加必要的代码注释

3. **用户体验**:
   - 所有操作提供即时反馈
   - 错误提示要友好明确
   - 加载状态要清晰

4. **CRS 集成**:
   - 所有密钥操作必须通过 CRS API
   - 实现完整的错误处理
   - 考虑 CRS 服务不可用的降级策略

---

**创建者**: Sprint 12 Team
**上一阶段**: Phase 4 🔴 RED（测试编写）
**当前阶段**: Phase 5 🟢 GREEN（组件实现）
**下一阶段**: Phase 6 🔵 REFACTOR（重构优化）
