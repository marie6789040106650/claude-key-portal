# P3.1 - 测试修复行动计划

> **创建时间**: 2025-10-10
> **目标**: 提升测试通过率从52%到80%+
> **工作量**: 2-3天
> **优先级**: ⭐⭐⭐ 最高

---

## 📊 当前测试状态

```
测试通过率: 52% (504/969)
├── 通过: 504个
├── 失败: 51个  ← 需要修复
└── 跳过: 414个 ← 需要启用

测试套件状态:
├── 通过: 34个
├── 失败: 17个
└── 跳过: 17个
```

---

## 🎯 修复目标

### 阶段目标
- [ ] 测试通过率 ≥ 80% (至少775/969)
- [ ] 修复所有失败的测试 (51个)
- [ ] 启用关键跳过测试 (评估后)
- [ ] 测试执行时间 < 30秒

---

## 📋 问题分类分析

### Task 1: Mock相关测试修复 (预计1天)

**问题分析**:
```bash
# 查看失败的测试
npm test 2>&1 | grep -A 3 "FAIL"
```

**常见问题**:
1. **Toast Mock问题**
   - `useToast` mock不正确
   - Toast组件渲染失败
   - 解决方案: 统一Toast mock配置

2. **定时器问题**
   - `setTimeout/setInterval`未正确mock
   - 异步状态更新测试失败
   - 解决方案: 使用`jest.useFakeTimers()`

3. **事件处理问题**
   - 键盘/鼠标事件未触发
   - 事件监听器未清理
   - 解决方案: 使用`@testing-library/user-event`

**修复步骤**:
```bash
# 1. 识别失败测试
npm test -- --listTests | grep -E "(toast|timer|event)"

# 2. 逐个修复
npm test -- <test-file-path>

# 3. 验证修复
npm test -- --coverage
```

---

### Task 2: 跳过测试评估 (预计1天)

**跳过原因分析**:
- `it.skip()` - 开发时临时跳过
- `describe.skip()` - 整个套件跳过
- 条件跳过 - 环境相关

**处理策略**:
```typescript
// 1. 查找所有跳过的测试
grep -r "\.skip\|xit\|xdescribe" tests/

// 2. 分类处理
// - 必要测试: 修复并启用
// - 过时测试: 删除
// - 环境测试: 保持跳过(CI/CD相关)
```

**优先级**:
1. ⭐⭐⭐ 核心业务逻辑测试 - 必须启用
2. ⭐⭐ UI交互测试 - 评估后启用
3. ⭐ 边界情况测试 - 可以保持跳过

---

### Task 3: 测试稳定性优化 (预计0.5天)

**问题**:
- 测试间相互影响
- 异步测试不稳定
- 测试执行慢

**解决方案**:

#### 1. 隔离测试环境
```typescript
// 每个测试前后清理
beforeEach(() => {
  jest.clearAllMocks()
  jest.resetModules()
})

afterEach(() => {
  cleanup()
  jest.clearAllTimers()
})
```

#### 2. 修复异步测试
```typescript
// ❌ 错误写法
test('async test', () => {
  fetchData().then(data => {
    expect(data).toBe('result')
  })
})

// ✅ 正确写法
test('async test', async () => {
  const data = await fetchData()
  expect(data).toBe('result')
})
```

#### 3. 优化测试性能
```typescript
// jest.config.js
{
  maxWorkers: 4, // 并行执行
  testTimeout: 10000, // 10秒超时
  clearMocks: true,
  resetMocks: true,
}
```

---

## 🔧 具体修复步骤

### Day 1: Mock测试修复

**上午 (4小时)**:
```bash
# 1. Toast Mock统一配置
# 创建: tests/setup/toast-mock.ts

# 2. 修复Toast相关测试
npm test -- --testPathPattern=toast

# 3. 修复定时器测试
npm test -- --testPathPattern=timer
```

**下午 (4小时)**:
```bash
# 4. 修复事件处理测试
npm test -- --testPathPattern=event

# 5. 验证修复效果
npm test -- --coverage
```

**验收标准**:
- [ ] Toast测试全部通过
- [ ] 定时器测试全部通过
- [ ] 事件处理测试全部通过

---

### Day 2: 跳过测试处理

**上午 (4小时)**:
```bash
# 1. 列出所有跳过测试
grep -r "\.skip" tests/ > skipped_tests.txt

# 2. 分类评估
# 编辑skipped_tests.txt，标记处理方式

# 3. 启用核心测试
# 移除.skip，修复测试代码
```

**下午 (4小时)**:
```bash
# 4. 运行启用的测试
npm test

# 5. 修复失败测试
# 逐个解决问题

# 6. 删除过时测试
git rm <obsolete-test-files>
```

**验收标准**:
- [ ] 核心测试全部启用
- [ ] 过时测试已删除
- [ ] 测试通过率 > 75%

---

### Day 3: 稳定性优化与验证

**上午 (3小时)**:
```bash
# 1. 添加测试隔离
# 更新beforeEach/afterEach

# 2. 修复异步测试
# 统一使用async/await

# 3. 优化测试配置
# 更新jest.config.js
```

**下午 (3小时)**:
```bash
# 4. 完整测试运行
npm test -- --coverage

# 5. CI/CD验证
git push origin feature/p3-test-fixes

# 6. 文档更新
# 记录修复过程和结果
```

**验收标准**:
- [ ] 测试通过率 ≥ 80%
- [ ] 测试执行稳定
- [ ] CI/CD通过
- [ ] 文档更新完成

---

## 🔍 常用调试命令

### 查看失败测试
```bash
# 只运行失败的测试
npm test -- --onlyFailures

# 详细错误信息
npm test -- --verbose

# 单个测试文件
npm test -- <test-file-path>
```

### 测试覆盖率
```bash
# 生成覆盖率报告
npm test -- --coverage

# 查看HTML报告
open coverage/lcov-report/index.html
```

### 测试性能分析
```bash
# 显示执行时间
npm test -- --showSeed --verbose

# 识别慢测试
npm test 2>&1 | grep -E "[0-9]{4,} ms"
```

---

## ✅ 验收清单

### 代码质量
- [ ] 测试通过率 ≥ 80%
- [ ] 无跳过的核心测试
- [ ] 测试隔离良好
- [ ] 异步测试稳定

### 工程质量
- [ ] CI/CD稳定通过
- [ ] 测试执行 < 30秒
- [ ] 覆盖率报告正常
- [ ] 无警告和错误

### 文档完整
- [ ] 修复过程记录
- [ ] 问题解决方案文档
- [ ] 测试最佳实践更新

---

## 📝 提交规范

### Git提交格式
```bash
# 修复测试
git commit -m "test: fix toast mock issues (🔴 RED)"
git commit -m "test: enable skipped core tests (🟢 GREEN)"
git commit -m "test: optimize test isolation (🔵 REFACTOR)"

# 文档更新
git commit -m "docs: add test fix summary"
```

---

## 🚀 开始命令

```bash
# 1. 创建修复分支
git checkout -b feature/p3-test-fixes

# 2. 查看当前测试状态
npm test -- --listTests
npm test 2>&1 | tee test-status.log

# 3. 开始修复
# 按照Day 1 → Day 2 → Day 3顺序执行

# 4. 完成后合并
git checkout develop
git merge --no-ff feature/p3-test-fixes
git tag -a v1.2.0 -m "P3.1: Test fixes complete"
```

---

## 📚 参考资源

### 测试工具文档
- Jest: https://jestjs.io/docs/getting-started
- React Testing Library: https://testing-library.com/docs/react-testing-library/intro
- User Event: https://testing-library.com/docs/user-event/intro

### 项目文档
- `DDD_TDD_GIT_STANDARD.md` - TDD标准
- `CLAUDE.md` - 项目规范
- `tests/setup/` - 测试配置

---

**准备好开始修复了吗？** 🔧

执行: `git checkout -b feature/p3-test-fixes` 开始P3.1！
