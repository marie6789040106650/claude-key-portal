# 🎯 功能需求和项目边界

## 核心功能

### 1. 用户认证系统（本地实现）

#### 1.1 用户注册
```typescript
POST /api/auth/register
{
  email: string;       // 邮箱
  password: string;    // 密码（8+ 字符，含大小写+数字+特殊字符）
  name: string;        // 用户名
}
```

**功能特性**:
- ✅ 邮箱格式验证
- ✅ 密码强度检查
- ✅ 重复邮箱检测
- ✅ 密码 bcrypt 加密
- ❌ 邮箱验证（不实现）

#### 1.2 用户登录
```typescript
POST /api/auth/login
{
  email: string;
  password: string;
}

Response:
{
  token: string;       // JWT token
  userId: string;
  expiresAt: number;
}
```

**功能特性**:
- ✅ JWT 令牌认证
- ✅ Token 有效期 24 小时
- ✅ 自动刷新机制
- ✅ 安全的会话管理

#### 1.3 个人中心
- 个人信息编辑
- 头像上传
- 密码修改
- 偏好设置（主题、语言、时区）

---

### 2. 密钥管理（代理 CRS）

#### 2.1 创建密钥
```typescript
POST /api/keys
{
  name: string;                    // 密钥名称
  rateLimit?: number;              // 速率限制（次/分钟）
  expiresAt?: string;              // 过期时间
  modelRestrictions?: string[];    // 模型限制
  localNotes?: string;             // 本地备注
  tags?: string[];                 // 本地标签
}
```

**流程**:
1. Portal 验证用户输入
2. Portal 调用 CRS Admin API 创建密钥
3. CRS 返回密钥信息
4. Portal 创建本地映射关系（user_id <-> crs_key_id）
5. Portal 存储本地扩展字段（备注、标签）

#### 2.2 查看密钥列表
```typescript
GET /api/keys?page=1&limit=20&status=active&search=xxx

Response:
{
  keys: [
    {
      id: string;               // CRS 密钥 ID
      key: string;              // 密钥字符串（脱敏）
      name: string;             // 名称
      status: string;           // 状态
      todayCalls: number;       // 今日调用
      todayTokens: number;      // 今日 Token
      createdAt: string;

      // 本地扩展字段
      localNotes?: string;      // 备注
      tags?: string[];          // 标签
      isFavorite?: boolean;     // 收藏
    }
  ],
  total: number;
  page: number;
  limit: number;
}
```

**数据来源**:
- CRS 数据：密钥、状态、使用量
- 本地数据：备注、标签、收藏

#### 2.3 查看密钥详情
```typescript
GET /api/keys/:id

Response:
{
  // 基础信息（来自 CRS）
  id: string;
  key: string;
  name: string;
  status: 'active' | 'inactive' | 'expired';
  createdAt: string;
  expiresAt?: string;

  // 配置信息（来自 CRS）
  rateLimit: number;
  modelRestrictions: string[];

  // 使用统计（来自 CRS）
  totalCalls: number;
  totalTokens: number;
  todayCalls: number;
  todayTokens: number;
  errorRate: number;

  // 本地扩展
  localNotes?: string;
  tags?: string[];
  isFavorite?: boolean;
}
```

#### 2.4 更新密钥
```typescript
PUT /api/keys/:id
{
  name?: string;
  localNotes?: string;
  tags?: string[];
  isFavorite?: boolean;

  // 以下字段同步到 CRS
  rateLimit?: number;
  status?: string;
}
```

#### 2.5 删除密钥
```typescript
DELETE /api/keys/:id
```

**流程**:
1. Portal 调用 CRS Admin API 删除密钥
2. Portal 删除本地映射关系
3. Portal 记录审计日志

---

### 3. 使用统计（数据来自 CRS）

#### 3.1 仪表板
```typescript
GET /api/dashboard

Response:
{
  overview: {
    totalKeys: number;
    activeKeys: number;
    todayCalls: number;
    todayTokens: number;
    errorRate: number;
  },

  trends: [
    {
      date: string;
      calls: number;
      tokens: number;
      errors: number;
    }
  ],

  modelDistribution: [
    {
      model: string;
      percentage: number;
      calls: number;
    }
  ],

  topKeys: [
    {
      id: string;
      name: string;
      calls: number;
    }
  ]
}
```

**数据聚合**:
1. 从本地获取用户的所有密钥 ID
2. 批量查询 CRS 统计数据
3. 聚合并计算
4. 缓存 1 分钟

#### 3.2 使用统计
```typescript
GET /api/stats?timeRange=7d&groupBy=day

Response:
{
  summary: {
    totalCalls: number;
    totalTokens: number;
    avgResponseTime: number;
    errorRate: number;
  },

  timeline: [
    {
      timestamp: string;
      calls: number;
      tokens: number;
      errors: number;
    }
  ],

  models: [
    {
      model: string;
      calls: number;
      tokens: number;
    }
  ]
}
```

#### 3.3 调用日志
```typescript
GET /api/logs?page=1&limit=50&keyId=xxx&status=error

Response:
{
  logs: [
    {
      id: string;
      timestamp: string;
      keyId: string;
      model: string;
      inputTokens: number;
      outputTokens: number;
      responseTime: number;
      status: 'success' | 'error';
      errorMessage?: string;
    }
  ],
  total: number;
}
```

---

### 4. 安装指导（本地实现）

#### 4.1 平台检测
```typescript
GET /api/install/detect

Response:
{
  platform: 'windows' | 'macos' | 'linux';
  shell: 'bash' | 'zsh' | 'powershell';
  recommended: string;  // 推荐的配置方式
}
```

#### 4.2 配置脚本生成
```typescript
POST /api/install/generate
{
  keyId: string;
  platform: string;
  environment: 'bash' | 'zsh' | 'powershell';
}

Response:
{
  envVars: string;      // 环境变量配置
  codexConfig: string;  // Codex 配置文件
  instructions: string[];  // 安装步骤
}
```

**生成内容**:

**Bash/Zsh 配置**:
```bash
# 添加到 ~/.bashrc 或 ~/.zshrc
export ANTHROPIC_BASE_URL="https://claude.just-play.fun/api"
export ANTHROPIC_AUTH_TOKEN="<用户密钥>"
export CRS_OAI_KEY="<用户密钥>"
```

**PowerShell 配置**:
```powershell
# 添加到 PowerShell Profile
$env:ANTHROPIC_BASE_URL = "https://claude.just-play.fun/api"
$env:ANTHROPIC_AUTH_TOKEN = "<用户密钥>"
$env:CRS_OAI_KEY = "<用户密钥>"
```

**Codex 配置文件**:
```toml
# ~/.codex/config.toml
[api]
base_url = "https://claude.just-play.fun/api"
api_key = "<用户密钥>"

[auth]
token = "<用户密钥>"
```

#### 4.3 安装验证
```typescript
POST /api/install/verify
{
  platform: string;
  environment: string;
}

Response:
{
  envVarsSet: boolean;
  codexConfigExists: boolean;
  claudeCodeInstalled: boolean;
  issues: string[];
}
```

---

## 项目边界

### ✅ 我们提供的服务

#### 核心服务
1. **用户管理** - 完全本地实现
   - 用户注册、登录、认证
   - 用户信息管理
   - 会话管理

2. **密钥管理界面** - 代理 CRS
   - 密钥 CRUD 操作界面
   - 本地扩展功能（备注、标签、收藏）
   - 用户-密钥映射关系

3. **数据可视化** - 数据来自 CRS
   - 仪表板
   - 使用统计图表
   - 调用日志展示

4. **安装指导** - 本地实现
   - 配置脚本生成
   - 平台特定的安装步骤
   - 环境检测和验证

#### 增值功能
5. **个性化**
   - 密钥备注和标签
   - 收藏功能
   - 主题切换
   - 语言选择

6. **安全审计**
   - 操作日志记录
   - 登录历史
   - 异常检测

---

### ❌ 我们不提供的服务

#### 明确不做的事情

1. **密钥生成逻辑**
   ```
   ❌ 不生成密钥（由 CRS 生成）
   ❌ 不存储密钥（只存储映射关系）
   ❌ 不验证密钥（由 CRS 验证）
   ```

2. **API 中转服务**
   ```
   ❌ 不代理用户的 Claude API 请求
   ❌ 不转发 AI 对话
   ❌ 不缓存 AI 响应
   ❌ 不做负载均衡
   ```

3. **使用量计算**
   ```
   ❌ 不统计调用次数（由 CRS 统计）
   ❌ 不计算 Token 数（由 CRS 计算）
   ❌ 不记录调用日志（由 CRS 记录）
   ```

4. **速率限制**
   ```
   ❌ 不实施速率限制（由 CRS 实施）
   ❌ 不做流量控制（由 CRS 控制）
   ```

5. **模型管理**
   ```
   ❌ 不管理 AI 模型
   ❌ 不配置模型限制（由 CRS 配置）
   ```

---

### 🔗 依赖关系

#### 强依赖
1. **CRS Admin API** - 核心依赖
   - 必须可用才能创建/删除密钥
   - 必须可用才能获取统计数据
   - 故障时需要降级方案

2. **PostgreSQL** - 数据存储
   - 用户数据
   - 映射关系
   - 审计日志

3. **Redis** - 缓存
   - CRS 响应缓存
   - 会话存储
   - 速率限制

#### 可选依赖
4. **邮件服务** - 通知（未来）
   - 密码重置（Phase 2）
   - 通知提醒（Phase 3）

---

## 功能优先级

### P0 - 必须有（MVP）

- ✅ 用户注册登录
- ✅ 密钥列表展示
- ✅ 密钥创建（代理 CRS）
- ✅ 基础统计展示
- ✅ 安装指导页面

### P1 - 应该有（V1.0）

- ✅ 密钥详情页面
- ✅ 密钥更新和删除
- ✅ 仪表板（完整）
- ✅ 使用统计图表
- ⏳ 本地扩展功能（备注、标签）

### P2 - 可以有（V1.5）

- ⏳ 调用日志查询
- ⏳ 高级搜索和筛选
- ⏳ 导出功能（CSV、JSON）
- ⏳ 个性化主题

### P3 - 未来有（V2.0）

- ⏳ 团队协作功能
- ⏳ 多租户支持
- ⏳ Webhook 集成
- ⏳ API 开放平台

---

## 非功能性需求

### 性能要求
- API 响应时间 < 100ms（不含 CRS 调用）
- CRS 代理请求 < 500ms
- 页面加载时间 < 2s
- 支持 100 并发用户

### 安全要求
- JWT 令牌认证
- HTTPS 强制
- 密码 bcrypt 加密（10 rounds）
- SQL 注入防护（Prisma ORM）
- XSS/CSRF 防护
- 审计日志完整

### 可用性要求
- 服务可用性 > 99%
- CRS 故障时降级可用
- 自动故障恢复
- 数据自动备份

### 兼容性要求
- 浏览器：Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- 移动端：iOS 14+, Android 10+
- 响应式设计：320px - 2560px

---

## 质量标准

### 代码质量
- 测试覆盖率 > 80%
- 无严重安全漏洞（Snyk 扫描）
- 遵循 ESLint 规则
- TypeScript strict 模式
- 所有 PR 需 Code Review

### 用户体验
- 注册流程 < 1 分钟
- 创建密钥 < 30 秒
- 界面简洁直观
- 错误提示清晰
- 加载状态反馈

### 运维质量
- 自动化部署
- 监控告警完善（Sentry）
- 日志完整可查（Winston）
- 备份恢复可靠（每日备份）

---

## 技术限制

### CRS 依赖限制
- CRS API 不可用时，密钥管理功能受限
- CRS 响应慢时，影响用户体验
- CRS 数据更新延迟（最多 5 分钟）

### 数据库限制
- PostgreSQL 单表最大 10GB
- 并发写入受限
- 需要定期归档旧数据

### Redis 限制
- 单个 value 最大 512MB
- 内存限制需要合理设置 TTL
- 故障时降级到直连 CRS

---

**文档版本**: v1.0
**最后更新**: 2025-01-01
